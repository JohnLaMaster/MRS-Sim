\section{Methods}\label{sec:Methods}
\subsection{Physics Model Algorithm}
The proposed physics model was developed after a thorough review of current state-of-the-art fitting algorithms (LCModel\cite{Provencher2001}, Osprey\cite{Oeltzschner2020}, FSL-MRS\cite{Clarke2021}, etc.). Commonly modeled spectral features and components were identified for inclusion, allowing for a large variety of scenarios and artifacts. The order of application was further specified for different operations and along with appropriate ranges and distributions for the underlying model parameters. The model was parameterized as follows:
\input{equations/eqn:physics_model.tex}
\noindent where $N$ is the whole set of metabolites being modeled, $M_n$ is the scaling factor for metabolite $n$, the Lorentzian variable $d_n$ and the Gaussian variable $g_n$ combine to define a Voigt lineshape, $t$ is time, and $\Delta f_n$ is the metabolite-specific frequency shift. Global zero- and first-order phase offsets are added using $\phi_0$ and $\phi_1$ while eddy current effects are described using two variables as a function of time $t$: the amplitude, $A_0$, and the time constant, $tc_0$. In lieu of the Gaussian term, imperfect shimming and severe lineshape distortions associated with large susceptibility effects can be applied using $\Delta\omega_r$, which is the modeled $B_0$ at location $r$ inside the voxel of interest. $snr_0$ is the desired SNR of the spectrum, while $baseline$ and $resH_2O$ are semi-parameterized signals that account for the broad baseline offset and the poorly defined residual water contributions. If coil-combined FIDs are required, then the simulation can stop after Eqn. \ref{eqn:PM:step1}. Multi-coil acquisitions are simulated in Eqn. \ref{eqn:PM:step2} in which the operator $\mathcal{C}oil$ generates $C$ coil transients and applies a distribution of SNR values and coil weights using $snr_c$ and $sens_c$. Frequency drifts and phase drifts are then added using $\Delta f_c$ and $\Delta \phi_c$, respectively. When necessary, Eqn. \ref{eqn:PM:step3} can apply apodization using $T_L$ in Hz and the FIDs can be zero-filled to length $len$. Then the Fourier transform $\mathcal{F}$ can convert the FIDs to the frequency domain. %Each term is discussed in more detail below. 
The following sections are presented in order according to their implementation in the physics model and discuss the terms above in greater detail. A step-by-step visualization of this model is illustrated in Fig. \ref{fig:PM compilation}.

\input{sections/subsec:02:PM.tex}

\subsection{Exporting Data}\label{subsec:exporting data}
The default export file format is .mat. These files include the data, spectral fits, simulation parameters, baseline offsets, and quantification results. To facilitate the use of the simulated spectra in various software packages, they are also exported in the NIfTI-MRS format\cite{Clarke2022}.
 
\subsection{Fitting Parameter Analysis}\label{subsec:Fitting Parameter Analysis}
The process of simulating a new dataset requires careful consideration of various factors, including the selection of appropriate parameter ranges and distributions. Customization of these parameters depends on the intended use and application of the dataset. For example, when creating deep learning-based quantification models, it is beneficial to use independent, uniform distributions that include all values the model will be expected to encounter. On the other hand, when validating a traditional spectral fitting model that includes soft constraints, it is crucial to incorporate those constraints when defining the parameter distributions. This ensures that the simulated dataset accurately reflects the underlying distribution of the target dataset. 

To create a dataset that accurately mimics in vivo conditions, it is crucial to have precise descriptions of clinical fitting parameters. This work does not provide scenario-specific parameter recommendations, as it is beyond the scope of this work. However, some tools are provided to assist in identifying ranges and distributions to match an existing dataset. In collaboration with the developers of Osprey\cite{Oeltzschner2020}, new functionality was added to their software to export the spectral fitting parameters after quantification. The tools in this framework can load those exported files and prepare the data for further analysis. Currently, this framework uses the Python library Fitter\cite{Cokelaer2019} to identify the best-fitting probability distribution for each parameter. \textit{A priori} knowledge, either from prior knowledge or data exploration, can narrow down the search range and accelerate the analysis. The results for each parameter include evaluation metrics for the best performing distributions as well as a numerical characterization of the best fitting distribution.
 

\subsection{Code}
This repository was written in PyTorch 1.11.0 and Python 3.9.7. Since this framework generates batches of spectra instead of individual spectra sequentially, a simulation batch size needs to be specified which will be affected by the spectral length and complexity of the simulations. As long as the batch size is set appropriately given the users' amount of RAM, this framework can be employed on standard computers without any special hardware. After publication, the repository will be available on GitHub, at https://github.com/JohnLaMaster/MRS-Sim, and MRSHub.

Metabolite and model parameter recommendations are provided as default values and are included in the Supporting Information Section 2 and the online repository. Model parameter values generally come from the default values of spectral fitting programs\cite{Oeltzschner2020,Provencher1993,Simpson2017} while the parameters describing the metabolites come from literature\cite{deGraaf2007,deGraaf2018,Gudmundson2023,Landheer2021,Wermter2017,Wyss2018}. For the most current information, please refer to the repository.


 
\subsubsection{Data Evaluation}\label{methods:data evaluation}% and Analysis
Validating synthetic data is challenging because there is no gold standard and the "realness" of the data depends on both the simulation methods, i.e. equations and components, and the simulation parameter values. This makes directly evaluating the simulated spectra difficult. The scope of this work is focused on the simulation framework itself instead of recommending in vivo parameter values. Even though there is no quantitative metric describing the degree of in vivo realness, it is still important to evaluate the model outputs qualitatively. Therefore, the most appropriate approach for evaluating this protocol is to evaluate the simulation methods described above and then visually assess the outputs. 

The selection of simulations presented in Sec. \ref{sec:Results} focuses on short echo (TE=30ms) 3T PRESS spectra with a spectral width of 2000Hz and randomly sampled parameters. The concentrations were sampled with respect to total creatine (tCr). The choice of short echo spectra is motivated by their ability to capture a broader range of metabolite peaks compared to long echo spectra. The simulations presented include metabolites sampled from a comprehensive set of common brain metabolites including ascorbate (Asc), aspartate (Asp), choline (Ch), creatine (Cr), $\gamma$-aminobutyric acid (GABA), glutamine (Gln), glucose (Glu), glycerylphosphocholine (GPC), glutathione (GSH), lactate (Lac), myo-inositol (mI), N-ascetylaspartate (NAA), N-acetylaspartylglutamate (NAAG), phosphorylcholine (PCh), phosphocreatine (PCr), phosphoethanolamine (PE), scyllo-inositol (sI), taurine (Tau), and a variety of macromolecular and lipid basis functions. For consistency, the SNR was fixed to 15 and the chemical shift reference point was set to 4.65ppm. The metabolite concentrations and $T_2^*$ values, adapted from Wyss et al.\cite{Wyss2018}, were fixed to further emphasize the effects of the simulated artifacts. Except for Fig. \ref{fig:30ms samples curated clean} and Fig. \ref{fig:30ms samples curated dirty}, spectral baselines were also omitted for continuity and visual clarity. 
% 
% Individual spectra were simulated as templates to showcase the framework's capabilities with varying simulation components. 
The samples shown in Figs. \ref{fig:30ms samples lorentzians} to \ref{fig:30ms samples ecc} show standard spectral components and artifacts. Fig. \ref{fig:30ms samples coils} then shows examples of simulating multi-coil transients. The samples in Fig. \ref{fig:30ms B0 samples} show how the $B_0$ simulator affects a spectrum with varying mean inhomogeneity offsets. The samples in Fig. \ref{fig:30ms samples curated clean} show a single spectrum with various sampled baseline offsets and residual water signals. And finally, the samples in Fig. \ref{fig:30ms samples curated dirty} demonstrate the complete model. Those samples were generated by sampling and randomly applying all spectral artifacts, except zero-order phase because of how much it obfuscates spectral details.

It is important to note that while pulse sequence implications are integral to the overall simulation process, their detailed exploration is beyond the scope of this work. Therefore, the simulations in Sec. \ref{sec:Results} are restricted to a single pulse sequence and echo time. The main objective of this work is to manipulate pre-simulated basis sets until they approximate in vivo spectra, meaning the primary machinations of MRS-Sim are the same regardless of the basis functions used. Overall, the presented simulations using the PRESS sequence provide a valuable foundation for understanding the performance and capabilities of the MRS-Sim framework.


