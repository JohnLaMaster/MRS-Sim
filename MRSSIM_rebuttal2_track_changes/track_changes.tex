\documentclass[AMA,LATO1COL]{WileyNJD-v2}
%DIF LATEXDIFF DIFFERENCE FILE
%DIF DEL /home/john/Documents/Repositories/MRS-Sim/MRS-Sim_Main_Manuscript/main.tex   Wed Jul  5 13:09:48 2023
%DIF ADD /home/john/Documents/Repositories/MRS-Sim/MRS-Sim_rebuttal/main.tex          Thu Dec 21 10:09:50 2023

%DIF 3c3
%DIF < 
%DIF -------
\RequirePackage{ulem} %DIF > 
%DIF -------
\articletype{Article Type}%

\usepackage{pgf}
\usepackage{enumitem}
\usepackage{subfiles}
%DIF 9a9-11
 %DIF > 
\usepackage{longtable} %DIF > 
\usepackage{makecell} %DIF > 
%DIF -------

\received{01 July 2023}
% \revised{6 June 2023}
% \accepted{6 June 2023}

\raggedbottom

\newcommand\todo[1]{\textcolor{red}{#1}}

\newcommand\lowcomma{%
\settoheight{\commaheight}{\text{,}}%
\mathpunct{\adjustbox{valign=b,raise=-\commaheight}{\text{,}}}%
}

\usepackage[acronym]{glossaries}
\renewcommand{\glossarysection}[2][]{}
\makeglossaries
%DIF PREAMBLE EXTENSION ADDED BY LATEXDIFF
%DIF UNDERLINE PREAMBLE %DIF PREAMBLE
\RequirePackage[normalem]{ulem} %DIF PREAMBLE
\RequirePackage{color}\definecolor{RED}{rgb}{1,0,0}\definecolor{BLUE}{rgb}{0,0,1} %DIF PREAMBLE
\providecommand{\DIFadd}[1]{{\protect\color{blue}\uwave{#1}}} %DIF PREAMBLE
\providecommand{\DIFdel}[1]{{\protect\color{red}\sout{#1}}}                      %DIF PREAMBLE
%DIF SAFE PREAMBLE %DIF PREAMBLE
\providecommand{\DIFaddbegin}{} %DIF PREAMBLE
\providecommand{\DIFaddend}{} %DIF PREAMBLE
\providecommand{\DIFdelbegin}{} %DIF PREAMBLE
\providecommand{\DIFdelend}{} %DIF PREAMBLE
%DIF FLOATSAFE PREAMBLE %DIF PREAMBLE
\providecommand{\DIFaddFL}[1]{\DIFadd{#1}} %DIF PREAMBLE
\providecommand{\DIFdelFL}[1]{\DIFdel{#1}} %DIF PREAMBLE
\providecommand{\DIFaddbeginFL}{} %DIF PREAMBLE
\providecommand{\DIFaddendFL}{} %DIF PREAMBLE
\providecommand{\DIFdelbeginFL}{} %DIF PREAMBLE
\providecommand{\DIFdelendFL}{} %DIF PREAMBLE
%DIF END PREAMBLE EXTENSION ADDED BY LATEXDIFF

\begin{document}

\title{MRS-Sim: Open-Source Framework for Simulating In Vivo-like Magnetic Resonance Spectra\protect}

\author[1]{John LaMaster*}

\author[2]{Georg Oeltzschner}

\author[3]{Yan Li}

\authormark{J. LaMaster \textsc{et al.}}


\address[1]{\orgdiv{School of Computation, Information, and Technology}, \orgname{Technical University of Munich}, \orgaddress{\state{Bavaria}, \country{Germany}}}

\address[2]{\orgdiv{Russel H. Morgan Department of Radiology and Radiological Sciences}, \orgname{The Johns Hopkins' University School of Medicine}, \orgaddress{\state{Maryland}, \country{USA}}}

\address[3]{\orgdiv{Department of Radiology and Biomedical Imaging}, \orgname{University of California, San Francisco}, \orgaddress{\state{California}, \country{USA}}}

\DIFdelbegin %DIFDELCMD < \corres{*John LaMaster. \\\email{john.t.lamaster@gmail.com} \\Twiter: @JohnTLaMaster}
%DIFDELCMD < %%%
\DIFdelend \DIFaddbegin \corres{*John LaMaster. \\\email{john.t.lamaster@gmail.com} \\Twitter: @JohnTLaMaster}
\DIFaddend 

\DIFdelbegin %DIFDELCMD < \presentaddress{Munich Institute of Biomedical Engineering, Faculty of Computer Science, Technical University of Munich in the City of Garching, Boltzmannstr 11. Garching, Bavaria 85748, Germany.}
%DIFDELCMD < %%%
\DIFdelend \DIFaddbegin \presentaddress{Munich Institute of Biomedical Engineering, Faculty of Computer Science, Technical University of Munich in the City of Garching bei München, Boltzmannstr 11. 85748 Garching bei München, Bavaria, Germany.}
\DIFaddend 

\DIFdelbegin %DIFDELCMD < \abstract[Summary]{This work presents an open-source, publicly available in vivo-like data simulator for generating synthetic magnetic resonance spectroscopy data that is geared towards community development. The reproducibility crisis in MRS is a persistent problem because fitting pipelines produce conflicting results. Current literature shows inconsistent complexities and parameters when simulating data, limiting its generalizability and hindering reproducibility. MRS-Sim is a powerful tool for modeling the intricacies of MRS data for a variety of clinical scenarios. It uses high fidelity basis functions that are simulated for sequence- and vendor-specific acquisitions. The underlying physics model includes all spectral components found in standard spectral fitting routines and additionally includes several novel components. A 3D $B_0$ field map simulator can be used to model $B_0$ field inhomogeneities, which can vary from slight variations from imperfect shimming or severe distortions commonly found near the sinuses or deep brain structures. Then, a novel semi-parametric simulator generates poorly characterized residual water region and baseline offset contributions. This framework can simulate both coil-combined data and multi-coil transients. When simulating clinical-like datasets, it is important to study the underlying ranges and statistical distributions of the simulation parameters of the clinical data. Therefore, accompanying software can analyze the distributions and ranges of parameters in fitted datasets allowing simulations to be tailored to specific clinical data. 
%DIFDELCMD < 

%DIFDELCMD < The modularity of this framework makes it easy to customize simulations for a variety of clinical scenarios and prepares it for continued development. By simulating in vivo-like data, this framework can facilitate many tasks in MRS, including validating spectral fitting protocols and reproducibility analyses. Readily available, synthetic data will also empower deep learning research for MRS where clinical data might be unavailable or insufficient for training. Easy access to high quality synthetic data will help tackle reproducibility issues and further democratize MRS research.\\
%DIFDELCMD < Word count (abstract): 295 words\\
%DIFDELCMD < Word count (paper): 4,807 words} 
%DIFDELCMD < %%%
\DIFdelend \DIFaddbegin \abstract[Summary]{This work introduces MRS-Sim, an open-source, publicly available in vivo-like data simulator for generating synthetic magnetic resonance spectroscopy data. Current literature shows inconsistencies and varying parameters in simulating data, making it difficult to generalize and reproduce results. MRS-Sim is a powerful tool for modeling the complexities of MRS data for various clinical scenarios. It uses high fidelity basis functions to simulate sequence- and vendor-specific acquisitions. The underlying physics model includes all spectral components commonly found in standard spectral fitting routines and some novel components. The first is a 3D $B_0$ field map simulator to model $B_0$ field inhomogeneities, ranging from slight variations to severe distortions. The second is a novel semi-parametric simulator that generates poorly characterized residual water region signal and baseline offset contributions. This framework can simulate everything between raw multi-coil transients and preprocessed coil-combined data. 

A repository of information has been compiled to help non-expert users with general simulation of MRS data. When simulating clinical-like datasets, it is important to be able to study the underlying ranges and statistical distributions of the simulation parameters of the clinical data. Therefore, accompanying software can analyze the distributions and ranges of parameters in fitted datasets, allowing simulations to be tailored to specific clinical data.
% To facilitate general simulations for non-expert users, a repository of information relevant for these simulations has been compiled. To simulate clinical-like datasets, it is important to be able to study the underlying ranges and statistical distributions of the simulation parameters of the clinical data. Therefore, accompanying software can analyze the distributions and ranges of parameters in fitted datasets allowing simulations to be tailored to specific clinical data. 

The modularity of this framework allows for easy customization of simulations to suit a variety of clinical scenarios and encourages continued community development. By simulating in vivo-like data, this framework can aid in many tasks in MRS, including verifying spectral fitting protocols and reproducibility analyses. The availability of readily available, synthetic data will also assist deep learning research for MRS, particularly in cases where clinical data is insufficient or unavailable for training. Providing easy access to high-quality synthetic data will help address reproducibility issues and make MRS research more accessible to a wider audience.\\
Word count (abstract): 295 -> 297 words\\
Word count (*paper): 4,206 -> 5125 words\\
*Limited to intro, methods, results, and conclusions. Including auxiliary text (author info, etc.): 4,807 -> 5,757 words
} 
\DIFaddend 

\keywords{MRS, spectroscopy, in vivo, data simulation, synthetic data, open-source}


\jnlcitation{\cname{%
\author{LaMaster J.}, 
\author{G. Oeltzschner}, and 
\author{Y. Li}} (\cyear{2022}), 
\ctitle{MRS-Sim: Open-Source Framework for Simulating Realistic In Vivo-like MR Spectroscopy Data}, \cjournal{NMR in Biomedicine}.}%, \cvol{2017;00:1--6}.}

\maketitle

\section{Introduction}\label{sec:Introduction}
Magnetic resonance spectroscopy (MRS) is a non-invasive imaging modality that provides in vivo information on the metabolic profile of tissues\DIFdelbegin \DIFdel{, enabling the evaluation of various pathologies . MRS generates spectra that can be analyzed }\DIFdelend \DIFaddbegin \DIFadd{. It allows for evaluating various pathologies throughout the entire body by analyzing the spectra }\DIFaddend to quantify metabolite concentrations\DIFdelbegin \DIFdel{, providing valuable insights into tissue composition and metabolic activity}\DIFdelend . In the brain, MRS has been extensively used to investigate a wide range of pathologies, including neurodevelopmental\cite{Augustine2008,Laccetta2022,Tomiyasu2022} and neurodegenerative diseases\cite{Gao2014,Martin2007,McKiernan2023,Oz2016}, inborn errors of metabolism\cite{Cecil2006,Gropman2020,Lai2022}, brain tumors\cite{Calvar2005,Lukas2004,Padelli2022,Nelson2003}, as well as age-related changes\cite{Forester2010,Inglese2004,Reyngoudt2012}. \DIFdelbegin \DIFdel{All of those studies are based on analyzing metabolite concentrations, or how the concentrations change. This is only possible with accurate post-processing and quantification steps.
 }\DIFdelend %DIF > All of those studies are based on analyzing metabolite concentrations, or how the concentrations change. %This is only possible with accurate post-processing and quantification steps.

\DIFdelbegin \DIFdel{For MRS to become a clinically relevant technique}\DIFdelend \DIFaddbegin \DIFadd{In order for MRS to be a widely used clinical imaging modality}\DIFaddend , it is important to \DIFdelbegin \DIFdel{assure }\DIFdelend \DIFaddbegin \DIFadd{ensure }\DIFaddend the precision and accuracy of MRS data \DIFdelbegin \DIFdel{analysis across a wide range of data scenarios, e.g. }\DIFdelend \DIFaddbegin \DIFadd{processing and analysis. %DIF > across a wide range of data scenarios, e.g. acquisition parameters, pulse sequences, data quality regimes, pediatrics versus adult subjects, and disease-related metabolic patterns. 
However, it can be challenging due to variations across scenarios, such as pulse sequence, }\DIFaddend acquisition parameters, data quality regimes, and \DIFdelbegin \DIFdel{disease-related metabolic patterns. Clinical MRS data varies drastically across these dimensions, but is }\DIFdelend \DIFaddbegin \DIFadd{biological differences (adult versus pediatric subjects\mbox{%DIFAUXCMD
\cite{Dezortova2008} }\hspace{0pt}%DIFAUXCMD
and disease related metabolic patterns\mbox{%DIFAUXCMD
\cite{Li2008}}\hspace{0pt}%DIFAUXCMD
). Such comprehensive collections of data are }\DIFaddend usually not widely available for method development and evaluation due to data privacy restrictions. Furthermore, in vivo data \DIFdelbegin \DIFdel{lacks access to a ground truth . This makes }\DIFdelend \DIFaddbegin \DIFadd{do not have access to ground truth values, making }\DIFaddend it difficult to determine \DIFdelbegin \DIFdel{how reliable, sensitive, and robust the quantitative outcomes are from }\DIFdelend \DIFaddbegin \DIFadd{the reliability, sensitivity, and robustness of }\DIFaddend different MRS analysis \DIFdelbegin \DIFdel{procedures}\DIFdelend \DIFaddbegin \DIFadd{protocols}\DIFaddend . Phantom data can be useful in developing and validating acquisition and analysis methods, but \DIFaddbegin \DIFadd{it }\DIFaddend usually does not adequately reflect \DIFaddbegin \DIFadd{the complexities of }\DIFaddend in vivo spectra. 
\DIFdelbegin \DIFdel{For example, phantom data does not contain broad signals from macromolecules and lipids, which are a major source of uncertainty during spectral modeling. In vivo MRS data is further affected by tissue and susceptibility heterogeneities, reflected in irregular lineshapes and artifacts.
 }\DIFdelend 

\DIFdelbegin \DIFdel{Recent years have seen a dramatic increase in the use of synthetic MRS data, catalyzed by the advent of machine learning\mbox{%DIFAUXCMD
\cite{Das2017} }\hspace{0pt}%DIFAUXCMD
(ML) and deep learning\mbox{%DIFAUXCMD
\cite{Gurbani2019, Hatami, Lee2019} }\hspace{0pt}%DIFAUXCMD
(DL) quantification algorithms that require vast amounts of data for training and validation. These deep learning techniques require datasets comprising tens of thousands to hundreds of thousands of spectra to be effective, a volume of data that few centers globally possess. As a result, generating realistic, in vivo-like synthetic data is necessary to facilitate more research into these applications. Many software packages\mbox{%DIFAUXCMD
\cite{Hogben2011, Landheer2021, Simpson2017,Smith1994, Soher2011, Stefan2009, Tal2020} }\hspace{0pt}%DIFAUXCMD
can now accurately calculate the evolution of spin systems during any given pulse sequence, enabling researchers to generate metabolite basis sets. These can be assembled into arbitrarily large datasets that can approximate in vivo spectra with known ground truth values, offering a pathway to evaluate accuracy and precision of data analysis methods.
 }\DIFdelend %DIF >  In vivo MRS data varies drastically across these dimensions, but is usually not widely available for method development and evaluation due to data privacy restrictions. Furthermore, in vivo data lacks access to a ground truth values making it difficult to determine how reliable, sensitive, and robust the quantitative outcomes are from different MRS analysis procedures. Phantom data can be useful in developing and validating acquisition and analysis methods, but usually does not adequately reflect the complexities of in vivo spectra. %For example, phantom data does not contain broad signals from macromolecules and lipids, which are a major source of uncertainty during spectral modeling. In vivo MRS data is further affected by tissue and susceptibility heterogeneities, reflected in irregular lineshapes and artifacts.


\DIFdelbegin \DIFdel{The main challenge of synthetic MRS data generation is to adequately incorporate }\DIFdelend \DIFaddbegin \DIFadd{A logical solution to these challenges is to generate synthetic data for a variety of experimental scenarios. %DIF > The main challenge of synthetic MRS data generation is to adequately incorporate all physical phenomena underlying in vivo data. 
However, generating synthetic MRS data can be challenging as well, as it requires adequately incorporating }\DIFaddend all physical phenomena underlying in vivo data. One \DIFdelbegin \DIFdel{aspect is the adequate choice of model parameters to reflect different }\DIFdelend \DIFaddbegin \DIFadd{of the significant aspects is to choose adequate model parameters that 
%DIF >  One such aspect is the adequate choice of model parameters to 
reflect different physiological and }\DIFaddend pathological conditions. \DIFdelbegin \DIFdel{For example, tumors have vastly different metabolic signatures than healthy tissue. More importantly, synthetic data needs }\DIFdelend \DIFaddbegin \DIFadd{Arguably more important is the need }\DIFaddend to capture acquisition-induced artifacts and nuisance signals \DIFaddbegin \DIFadd{commonly found in in vivo data }\DIFaddend that are difficult to reproduce in a phantom\DIFdelbegin \DIFdel{: }\DIFdelend \DIFaddbegin \DIFadd{, such as }\DIFaddend effects of susceptibility and field inhomogeneity, macromolecule, lipid, and residual water signals, and various other artifacts. 
\DIFdelbegin \DIFdel{While many }\DIFdelend \DIFaddbegin \DIFadd{Many }\DIFaddend research groups now routinely use synthetic data, \DIFdelbegin \DIFdel{the underlying software, crucial }\DIFdelend \DIFaddbegin \DIFadd{but the }\DIFaddend data generation models \DIFdelbegin \DIFdel{, }\DIFdelend and parameter distributions are rarely made publicly available.
\DIFdelbegin \DIFdel{This not only }\DIFdelend %DIF >  While many research groups now routinely use synthetic data, the underlying software, crucial data generation models, and parameter distributions are rarely made publicly available. 
\DIFaddbegin \DIFadd{This lack of transparency }\DIFaddend hampers systematic comparison \DIFdelbegin \DIFdel{, but also }\DIFdelend \DIFaddbegin \DIFadd{and }\DIFaddend the formation of consensus best practices for synthetic data generation. 

\DIFdelbegin \DIFdel{Recent work has begun to compare the impact of various spectral modeling componentson metabolite quantification as well as the performance of commonly used spectral fitting models. \mbox{%DIFAUXCMD
\cite{Craven2022,Marjanska2021,Marjanska2022,Zollner2021} }\hspace{0pt}%DIFAUXCMD
Currently, these comparisons show worrisome agreement of metabolite quantities between the different linear combination fitting methods. Poor agreement between fitting methods prevents any sort of meaningful comparison between studies published by different institutions that employ different fitting protocols which limits the generalizability of published quantification parameters and any conclusions drawn from them. The }\DIFdelend \DIFaddbegin \DIFadd{It is evident from the literature that there is no standard set of best practices for simulating synthetic data. Simulations have been carried out using physical models with a range of complexity and spectral components\mbox{%DIFAUXCMD
\cite{Hatami,Das2018a,Das2018,Iqbal2018a}}\hspace{0pt}%DIFAUXCMD
. Most of these methods begin with simulating basis functions, assuming appropriate pulse sequence parameters for their specific scenario. These functions represent metabolites that can be collected and are then modulated by scaling factors representing their underlying concentrations. A simple Lorentzian lineshape is generally applied\mbox{%DIFAUXCMD
\cite{Hatami, Das2018a, Das2018} }\hspace{0pt}%DIFAUXCMD
with optional phase offsets\mbox{%DIFAUXCMD
\cite{Das2018,Iqbal2018a} }\hspace{0pt}%DIFAUXCMD
and frequency shifts\mbox{%DIFAUXCMD
\cite{Hatami}}\hspace{0pt}%DIFAUXCMD
. Finally, some type of broad baseline is typically added. These models are simple and do not fully capture the complexity of in vivo data. Additionally, they often contain non-public components such as baselines, macromolecules, and lipid signals that are either simulated in-house or extracted from private datasets, thus making detailed analysis of their models difficult.
}

%DIF >  The lack of standardized best practices is evident in literature which shows that synthetic data is simulated using physical models with a variety of complexity and spectral components.\cite{Hatami,Das2018a,Das2018,Iqbal2018a} Most of these methods begin with simulated basis functions that are assumed to have been simulated using appropriate pulse sequence parameters for the scenario of interest. These metabolite basis functions are then modulated by scaling factors that indicate their underlying concentrations. Most models then apply a simple Lorentzian lineshape.\cite{Hatami, Das2018a, Das2018} Phase offsets\cite{Das2018,Iqbal2018a} and frequency shifts\cite{Hatami} can optionally be applied. Finally, some type of broad baseline is typically added. These models are simple and do not capture the full complexity of in vivo data. Additionally, they often include non-public components such as baselines, macromolecules, and lipid signals that are either simulated in-house or extracted from private datasets, both of which prevent detailed analysis of their models.

%DIF >  Many software packages\cite{Hogben2011, Landheer2021, Simpson2017,Smith1994, Soher2011, Stefan2009, Tal2020} can already accurately calculate the evolution of spin systems for arbitrary pulse sequences, enabling the generation of metabolite basis sets, which form the backbone of in vivo simulation methods. 
%DIF >  These can then be assembled into arbitrarily large datasets that can approximate in vivo spectra with known ground truth values, offering a pathway to evaluate the accuracy and precision of data analysis methods.

\DIFadd{There are several software packages that claim to simulate in vivo spectra, such as FID-A\mbox{%DIFAUXCMD
\cite{Simpson2017}}\hspace{0pt}%DIFAUXCMD
, GAVA\mbox{%DIFAUXCMD
\cite{Soher2007}}\hspace{0pt}%DIFAUXCMD
, and VESPA\mbox{%DIFAUXCMD
\cite{Soher2023}}\hspace{0pt}%DIFAUXCMD
. However, the fundamental difference between these methods and the current work is the definition of "in vivo spectra". Previously, this term referred to simulating idealized spectra to evaluate parameter settings for developing new in vivo pulse sequences. In this work, "in vivo spectra" refers to the data that comes off a clinical scanner before post-processing and analysis begins. This new definition is meant to reframe the task of simulating synthetic data, to challenge what are assumed to be acceptable simplifications, and to advance the use of synthetic data for MRS applications. %DIF > . *As a results, synthetic in vivo spectra  | which should advance the use of synthetic data for MRS applications. 
While pulse sequences are necessary for generating basis sets, they are left to the many software options already available. The most relevant previous work is the recent update for the MARSS\mbox{%DIFAUXCMD
\cite{Landheer2021} }\hspace{0pt}%DIFAUXCMD
software which has added a new functionality called synMARSS that simulates synthetic spectra and incorporates many spectral artifacts. They provide an extensive user manual with equations describing their implementation. However, their source code is not available, nor can it be modified like MRS-Sim.
%DIF >  Previous work:
%DIF >  GAVA "This application provides a convenient method for generating a priori spectral information used in parametric spectral analyses and for visual examination of the effects of difference pulse sequences and parameter settings"
%DIF >  VESPA: focuses on simulating basis functions to help design pulse sequences
}


%DIF >  The continued rise in the use of synthetic MRS data without standardization will further exacerbate this problem.

\DIFadd{Over the past few years, there has been a significant }\DIFaddend rise in the use of synthetic MRS data\DIFdelbegin \DIFdel{without standardization will further exacerbate this problem. Literature shows that , already, }\DIFdelend \DIFaddbegin \DIFadd{. This increase is primarily due to the emergence of machine learning\mbox{%DIFAUXCMD
\cite{Das2017} }\hspace{0pt}%DIFAUXCMD
(ML) and deep learning\mbox{%DIFAUXCMD
\cite{Gurbani2019, Hatami, Lee2019} }\hspace{0pt}%DIFAUXCMD
(DL) analysis algorithms that require vast amounts of data for training and validation that few centers worldwide possess. Therefore, generating realistic, in vivo-like }\DIFaddend synthetic data is \DIFdelbegin \DIFdel{simulated using physical models with a variety of complexity and spectral components. \mbox{%DIFAUXCMD
\cite{Hatami,Das2018a,Das2018,Iqbal2018a}
 }\hspace{0pt}%DIFAUXCMD
}%DIFDELCMD < 

%DIFDELCMD < %%%
\DIFdel{Growing }\DIFdelend \DIFaddbegin \DIFadd{necessary to facilitate more research into these applications. Synthetic data has known ground truth values that are essential to evaluate the accuracy and precision of the analysis methods being developed. However, growing }\DIFaddend interest in training ML and DL models with synthetic data will compound the reproducibility and generalizability problems already being experienced in the traditional MRS field.\DIFaddbegin \DIFadd{\mbox{%DIFAUXCMD
\cite{Craven2022,Marjanska2021,Marjanska2022,Zollner2021} }\hspace{0pt}%DIFAUXCMD
}\DIFaddend To address this challenge, it is essential to establish standards and best practices for simulating \DIFaddbegin \DIFadd{synthetic }\DIFaddend MRS data. This will require \DIFdelbegin \DIFdel{collaboration and consensus-building among researchers }\DIFdelend \DIFaddbegin \DIFadd{researchers to collaborate and build consensus}\DIFaddend , as well as \DIFdelbegin \DIFdel{the development and adoption of }\DIFdelend \DIFaddbegin \DIFadd{develop and adopt }\DIFaddend open-source frameworks for data generation. \DIFdelbegin \DIFdel{To ensure widespread adoption, these frameworks will need to be applicable across a range of MRS applications. While a consensus-building effort is beyond the scope of this work, an open-source framework is not.
 }\DIFdelend %DIF > Unfortunately, a consensus-building effort surrounding synthetic data generation is beyond the scope of this work.  

%DIF <  \subsection{Contribution}\label{subsec:Contribution}
\DIFdelbegin \DIFdel{In this work , we therefore present }\DIFdelend %DIF >  Recent years have seen a dramatic increase in the use of synthetic MRS data, primarily catalyzed by the advent of machine learning\cite{Das2017} (ML) and deep learning\cite{Gurbani2019, Hatami, Lee2019} (DL) analysis algorithms that require vast amounts of data for training and validation. 
%DIF >  These deep learning techniques require datasets comprising tens of thousands to hundreds of thousands of spectra to be effective, a volume of data that few centers globally possess. As a result, generating realistic, in vivo-like synthetic data is necessary to facilitate more research into these applications. Synthetic data is uniquely suited for such applications because it inherently has known ground truth values required to evaluate the accuracy and precision of the analysis methods being developed. 
%DIF >  % Many software packages\cite{Hogben2011, Landheer2021, Simpson2017,Smith1994, Soher2011, Stefan2009, Tal2020} can already accurately calculate the evolution of spin systems for arbitrary pulse sequences, enabling researchers to generate metabolite basis sets. These can then be assembled into arbitrarily large datasets that can approximate in vivo spectra with known ground truth values, offering a pathway to evaluate the accuracy and precision of data analysis methods.
%DIF >  Growing interest in training ML and DL models with synthetic data will compound the reproducibility and generalizability problems already being experienced in the traditional MRS field.\cite{Craven2022,Marjanska2021,Marjanska2022,Zollner2021} To address this challenge, it will be essential to establish standards and best practices for simulating synthetic MRS data. This will require collaboration and consensus-building among researchers, as well as the development and adoption of open-source frameworks for data generation. Unfortunately, a consensus-building effort surrounding synthetic data generation is beyond the scope of this work.  %, therefore, this work focuses an open-source generation framework is well within the scope.
%DIF >  % To ensure widespread adoption, these frameworks will need to be applicable across a range of MRS applications. 
%DIF >  % While a consensus-building effort is beyond the scope of this work, an open-source framework is not.
\DIFaddbegin 


\DIFadd{This work presents }\DIFaddend a framework for a modular synthetic data generation model \DIFaddbegin \DIFadd{to address some of these challenges}\DIFaddend . The basic model \DIFdelbegin \DIFdel{applies }\DIFdelend \DIFaddbegin \DIFadd{uses }\DIFaddend well-defined distributions of physical parameters commonly used in linear-combination modeling software, corresponding to amplitudes, lineshapes, phases, and frequency shifts. Furthermore, it incorporates a realistic $B_0$ map generator to simulate in vivo-like field heterogeneity conditions, and uses parameterized models to describe residual water and smooth background signal contributions. 
\DIFdelbegin %DIFDELCMD < 

%DIFDELCMD < %%%
\DIFdelend The software is designed to simulate spectra at any stage of acquisition \DIFdelbegin \DIFdel{: }\DIFdelend from individual coil elements to unaligned transients to fully processed spectra. These features allow researchers to \DIFdelbegin \DIFdel{benchmark }\DIFdelend \DIFaddbegin \DIFadd{compare }\DIFaddend new data processing methods, not just modeling algorithms\DIFdelbegin \DIFdel{, against known ground truth parameters}\DIFdelend . The framework \DIFdelbegin \DIFdel{'s flexibility allows users to }\DIFdelend \DIFaddbegin \DIFadd{is highly flexible and can }\DIFaddend simulate custom-tailored datasets for a large variety of clinical scenarios. \DIFdelbegin \DIFdel{Accompanying this simulator are }\DIFdelend %DIF > This framework includes tools to analyze existing in vivo datasets and extract parameter distributions, which for augmenting in vivo data with similar synthetic data. 
\DIFaddbegin \DIFadd{This framework includes a detailed compilation of simulation parameters as well as }\DIFaddend tools to analyze existing in vivo \DIFdelbegin \DIFdel{clinical }\DIFdelend datasets and extract parameter distributions, which \DIFdelbegin \DIFdel{then allows }\DIFdelend for augmenting in vivo data with similar synthetic data. 
\DIFdelbegin %DIFDELCMD < 

%DIFDELCMD < %%%
\DIFdelend The open-source code base allows for seamless incorporation of future additions to expand the software's capabilities to include more types of spectra, spectral model components, and parameter distributions reflecting pathological metabolic signatures. This work is intended to be a community resource to provide researchers, trainees, and experts alike with access to high-quality and comparable synthetic data as a source of continuity in the field.
%DIF >  Therefore, this work presents
%DIF >  % In this work, we therefore present 
%DIF >  a framework for a modular synthetic data generation model. The basic model applies well-defined distributions of physical parameters commonly used in linear-combination modeling software, corresponding to amplitudes, lineshapes, phases, and frequency shifts. Furthermore, it incorporates a realistic $B_0$ map generator to simulate in vivo-like field heterogeneity conditions, and uses parameterized models to describe residual water and smooth background signal contributions. 
%DIF >  The software is designed to simulate spectra at any stage of acquisition: from individual coil elements to unaligned transients to fully processed spectra. These features allow researchers to benchmark new data processing methods, not just modeling algorithms, against known ground truth parameters. The framework's flexibility allows users to simulate custom-tailored datasets for a large variety of clinical scenarios. Accompanying this simulator are tools to analyze existing in vivo datasets and extract parameter distributions, which then allows for augmenting in vivo data with similar synthetic data. 
%DIF >  The open-source code base allows for seamless incorporation of future additions to expand the software's capabilities to include more types of spectra, spectral model components, and parameter distributions reflecting pathological metabolic signatures. This work is intended to be a community resource to provide researchers, trainees, and experts alike with access to high-quality and comparable synthetic data as a source of continuity in the field.
\DIFaddbegin 


%DIF >  The main challenge of synthetic MRS data generation is to adequately incorporate all physical phenomena underlying in vivo data. One aspect is the adequate choice of model parameters to reflect different pathological conditions. %For example, tumors have vastly different metabolic signatures than healthy tissue. 
%DIF >  % More importantly, synthetic data needs 
%DIF >  Arguably more important is the need to capture acquisition-induced artifacts and nuisance signals commonly found in in vivo data that are difficult to reproduce in a phantom: effects of susceptibility and field inhomogeneity, macromolecule, lipid, and residual water signals, and various other artifacts. While many research groups now routinely use synthetic data, the underlying software, crucial data generation models, and parameter distributions are rarely made publicly available. This not only hampers systematic comparison, but also the formation of consensus best practices for synthetic data generation. Literature shows that synthetic data is simulated using physical models with a variety of complexity and spectral components.\cite{Hatami,Das2018a,Das2018,Iqbal2018a} The continued rise in the use of synthetic MRS data without standardization will further exacerbate this problem.

%DIF >  Recent work has begun to compare the impact of various spectral modeling components on metabolite quantification as well as the performance of commonly used spectral fitting models.\cite{Craven2022,Marjanska2021,Marjanska2022,Zollner2021} Currently, these comparisons show worrisome agreement of metabolite quantities between the different linear combination fitting methods. Poor agreement between fitting methods prevents any sort of meaningful comparison between studies published by different institutions that employ different fitting protocols which limits the generalizability of published quantification parameters and any conclusions drawn from them.

%DIF >  Growing interest in training ML and DL models with synthetic data will compound the reproducibility and generalizability problems already being experienced in the traditional MRS field. To address this challenge, it is essential to establish standards and best practices for simulating MRS data. This will require collaboration and consensus-building among researchers, as well as the development and adoption of open-source frameworks for data generation. To ensure widespread adoption, these frameworks will need to be applicable across a range of MRS applications. While a consensus-building effort is beyond the scope of this work, an open-source framework is not.

 
%DIF >  % \subsection{Contribution}\label{subsec:Contribution}
%DIF >  In this work, we therefore present a framework for a modular synthetic data generation model. The basic model applies well-defined distributions of physical parameters commonly used in linear-combination modeling software, corresponding to amplitudes, lineshapes, phases, and frequency shifts. Furthermore, it incorporates a realistic $B_0$ map generator to simulate in vivo-like field heterogeneity conditions, and uses parameterized models to describe residual water and smooth background signal contributions.

%DIF >  The software is designed to simulate spectra at any stage of acquisition: from individual coil elements to unaligned transients to fully processed spectra. These features allow researchers to benchmark new data processing methods, not just modeling algorithms, against known ground truth parameters. The framework's flexibility allows users to simulate custom-tailored datasets for a large variety of clinical scenarios. Accompanying this simulator are tools to analyze existing in vivo datasets and extract parameter distributions, which then allows for augmenting in vivo data with similar synthetic data.

%DIF >  The open-source code base allows for seamless incorporation of future additions to expand the software's capabilities to include more types of spectra, spectral model components, and parameter distributions reflecting pathological metabolic signatures. This work is intended to be a community resource to provide researchers, trainees, and experts alike with access to high-quality and comparable synthetic data as a source of continuity in the field.
\DIFaddend 


\section{Methods}\label{sec:Methods}
\subsection{Physics Model Algorithm}
\DIFdelbegin \DIFdel{In literature, various MRS physics models have been proposed to simulate brain spectra. They begin with simulated basis functions that are assumed to have been simulated using appropriate pulse sequence parameters for the scenario of interest. These metabolite basis functions are then modulated by scaling factors that indicate their underlying concentrations. Most models then apply a simple Lorentzian lineshape.\mbox{%DIFAUXCMD
\cite{Hatami, Das2018a, Das2018} }\hspace{0pt}%DIFAUXCMD
Phase offsets\mbox{%DIFAUXCMD
\cite{Das2018,Iqbal2018a} }\hspace{0pt}%DIFAUXCMD
and frequency shifts\mbox{%DIFAUXCMD
\cite{Hatami} }\hspace{0pt}%DIFAUXCMD
can optionally be applied. Finally, some type of broad baseline is typically added. These models are simple and do not capture the full complexity of clinical data. Additionally, they often include non-public components such as baselines, macromolecules, and lipid signals that are extracted from private datasets. 
}\DIFdelend %DIF >  In literature, various MRS physics models have been proposed to simulate brain spectra. They begin with simulated basis functions that are assumed to have been simulated using appropriate pulse sequence parameters for the scenario of interest. These metabolite basis functions are then modulated by scaling factors that indicate their underlying concentrations. Most models then apply a simple Lorentzian lineshape.\cite{Hatami, Das2018a, Das2018} Phase offsets\cite{Das2018,Iqbal2018a} and frequency shifts\cite{Hatami} can optionally be applied. Finally, some type of broad baseline is typically added. These models are simple and do not capture the full complexity of clinical data. Additionally, they often include non-public components such as baselines, macromolecules, and lipid signals that are extracted from private datasets.

\DIFdelbegin \DIFdel{To }\DIFdelend %DIF >  \subsubsection{Overview}
\DIFaddbegin \DIFadd{The proposed physics model was developed to mirror the actual data acquisition sequence by reverse engineering the spectral fitting process. This process dictated which steps to include and order of operations, which are meant to ensure that any experimental fitting parameters will match the simulation parameters. 
In order to }\DIFaddend maximize generalizability and usefulness, the data simulator \DIFdelbegin \DIFdel{should }\DIFdelend \DIFaddbegin \DIFadd{needs to }\DIFaddend comprehensively model known spectral components, which were identified through a review of state-of-the-art fitting techniques and currently available fitting algorithms. These spectral components allow the model to account for a large variety of scenarios and artifacts. The \DIFdelbegin \DIFdel{physics model proposed in this work }\DIFdelend \DIFaddbegin \DIFadd{proposed physics model }\DIFaddend is described by the following set of equations:
%DIF <  \begin{table}
%DIF <  \centering
%DIF <  \begin{tabular}{l}
\DIFdelbegin %DIFDELCMD < 

%DIFDELCMD < %%%
%DIF <  F(\omega) = 
%DIFDELCMD < 

%DIFDELCMD < %%%
\DIFdelend \begin{subequations}
\begin{equation}
\DIFdelbegin \DIFdel{f(t) = \sum_{n}^{N} }%DIFDELCMD < \underbrace{M_n* basisfcn_n}%%%
\DIFdel{_{amplitude\ scaling} 
    }%DIFDELCMD < \underbrace{e^{-d_nt -g_nt^2}_{} }%%%
\DIFdel{_{lineshape} 
    }%DIFDELCMD < \underbrace{e^{-i\Delta f_nt}_{}}%%%
\DIFdel{_{fshift}
    }%DIFDELCMD < \underbrace{ e^{i(\phi_0 + \phi_1)}_{} }%%%
\DIFdel{_{phase}
    }%DIFDELCMD < \underbrace{e^{-iA_0*e^{-t/{{tc}_0}}t*2\pi}_{}}%%%
\DIFdel{_{eddyCurrents}  * }%DIFDELCMD < \underbrace{ \sum_{r=1}^R e^{-i\Delta\omega_r t} }%%%
\DIFdel{_{B_0\ inhomog.}  + 
    \mathcal{H}}%DIFDELCMD < \left (
%DIFDELCMD <     \underbrace{\mathcal{N}\left (0,snr_0, l \right )_{}}%%%
\DIFdel{_{noise} + baseline + resH_2O }%DIFDELCMD < \right )%%%
\DIFdelend \DIFaddbegin \begin{split}
    f(t)& = \\&\sum_{n}^{N} \underbrace{M_n* basisfcn_n}_{amplitude\ scaling} 
    \underbrace{e^{-d_nt -g_nt^2}_{} }_{lineshape} 
    \underbrace{e^{-i\Delta f_nt}_{}}_{fshift}
    \underbrace{ e^{i(\phi_0 + \phi_1)}_{} }_{phase}
    \underbrace{e^{-iA_0*e^{-t/{{tc}_0}}t*2\pi}_{}}_{eddyCurrents}  * \underbrace{ \sum_{r=1}^R e^{-i\Delta\omega_r t} }_{B_0\ inhomog.}  + 
    \mathcal{H}\left ( \underbrace{baseline + resH_2O}_{nuisance\ signals} \right ) +
    \underbrace{\mathcal{N}\big (0,snr_0, l \big )_{}}_{noise}
\end{split}
\DIFaddend \label{eqn:PM:step1}
\end{equation} \vspace{0.1em}

\begin{equation}
    f(t) = \mathcal{C}{oil}_0^C
    \left ( f(t) { ,\ }\underbrace{\overbrace{{snr_c}_{}}^{noise},\overbrace{sens_c}^{sensitivity}, \overbrace{\Delta f_c, \Delta\phi_c}^{drifts}}_{coil\ artifacts} \right ) \label{eqn:PM:step2} 
\end{equation} \vspace{0.1em}

\begin{equation}
    F(\omega) = \mathcal{F}\left ( zeroFill \left ( f(t) *  \underbrace{e^{-t*T_L}}_{apodize} \right ), len \right )  \label{eqn:PM:step3}
\end{equation} \vspace{0.1em}

%DIF <  \underbrace{e^{-iA_0*e^{-t/{{tc}_0}}t*2\pi}}_{eddyCurrents}
\DIFdelbegin %DIFDELCMD < 

%DIFDELCMD < %%%
%DIF < \begin{equation}
%DIF <     F_{Diff}(\omega) = F_{ON}(\omega) - F_{OFF}(\omega)  \label{eqn:PM:step4}
%DIF < \end{equation} \vspace{0.1em}
%DIFDELCMD < 

%DIFDELCMD < %%%
\DIFdelend \end{subequations}
\DIFdelbegin %DIFDELCMD < 

%DIFDELCMD < %%%
%DIF <  \end{tabular}
%DIF <  \end{table}
%DIF <  \begin{equation}\label{eqn:PM}
%DIF <      F(\omega) = \mathcal{F}\left ( 
%DIF <  \left ( 
%DIF <  \sum_{n}^{N} \underbrace{M_n* basisfcn_n}_{amplitude\ scaling} 
%DIF <  % \underbrace{e^{-d_nt -g_nt^2}_{} }_{lineshape} 
%DIF <  \underbrace{e^{-d_nt}e^{-g_nt^2}_{} }_{lineshape} 
%DIF <  \underbrace{e^{-i\Delta f_nt}_{}}_{fshift}
%DIF <  \ +\  \mathcal{H}\left(
%DIF <  \underbrace{\mathcal{N}\left (0,snr_0, l \right )_{}}_{noise} + baseline + resWater \right)
%DIF <  \right ) 
%DIF <  % \underbrace{ e^{i(\phi_0 + \phi_1)}_{} }_{phase} 
%DIF <  \underbrace{ e^{i\phi_0}e^{i\phi_1}_{} }_{phase} 
%DIF <  \underbrace{
%DIF <  \sum_{r=1}^R e^{-i\Delta\omega_r t}
%DIF <  }_{B_0\ inhomog.}
%DIF <  \right )
%DIF <  \end{equation}
\DIFdelend where $N$ is the whole set of metabolites being modeled, $M_n$ is the scaling factor for metabolite $n$, the Lorentzian variable $d_n$ and the Gaussian variable $g_n$ combine to define a Voigt lineshape, $t$ is time, and $\Delta f_n$ is the metabolite-specific frequency shift. Global zero- and first-order phase offsets are added using $\phi_0$ and $\phi_1$ while eddy current effects are described using two variables as a function of time $t$: the amplitude, $A_0$, and the time constant, $tc_0$. In lieu of the Gaussian term, imperfect shimming and severe lineshape distortions associated with large susceptibility effects can be applied using $\Delta\omega_r$, which is the modeled $B_0$ at location $r$ inside the voxel of interest. $snr_0$ is the desired SNR of the spectrum, while $baseline$ and $resH_2O$ are semi-parameterized signals that account for the broad baseline offset and the poorly defined residual water contributions. If coil-combined FIDs are required, then the simulation can stop after Eqn. \ref{eqn:PM:step1}. Multi-coil acquisitions are simulated in Eqn. \ref{eqn:PM:step2} in which the operator $\mathcal{C}oil$ generates $C$ coil transients and applies a distribution of SNR values and coil weights using $snr_c$ and $sens_c$. Frequency drifts and phase drifts are then added using $\Delta f_c$ and $\Delta \phi_c$, respectively. When necessary, Eqn. \ref{eqn:PM:step3} can apply apodization using $T_L$ in Hz and the FIDs can be zero-filled to length $len$. Then the Fourier transform $\mathcal{F}$ can convert the FIDs to the frequency domain. \DIFdelbegin \DIFdel{Each term is discussed in more detail below. 
}%DIFDELCMD < 

%DIFDELCMD < %%%
\subsubsection{\DIFdel{Overview}}
%DIFAUXCMD
\addtocounter{subsubsection}{-1}%DIFAUXCMD
\DIFdel{The proposed physics model was developed to mirror the actual data acquisition sequence and spectral fitting process. This reverse engineering informed both the steps to include and the order of operations, which are meant to ensure that any experimental fitting parameters will match the simulation parameters. }\DIFdelend %DIF > Each term is discussed in more detail below. 
The following sections are presented in order according to their implementation in the physics model \DIFaddbegin \DIFadd{and discuss the terms above in greater detail}\DIFaddend . A step-by-step visualization of this model is illustrated in Fig. \ref{fig:PM compilation}.




\begin{figure}
    \centering
    \begin{tabular}[l]{ccc}
    \begin{subfigure}[c]{0.315\textwidth}
        \includegraphics[width=0.95\textwidth,keepaspectratio]{images/PM_stages/pm_stages_1.eps}
        \caption{Original basis functions}
        \label{fig:PM_stages:basis functions}\vspace{0.2\baselineskip}
    \end{subfigure}&
    \begin{subfigure}[c]{0.315\textwidth}
        \includegraphics[width=0.95\textwidth,keepaspectratio]{images/PM_stages/pm_stages_2.eps}
        \caption{Modulated basis functions}
        \label{fig:PM_stages:modulated}\vspace{0.2\baselineskip}
    \end{subfigure}&
    \begin{subfigure}[c]{0.315\textwidth}
        \includegraphics[width=0.95\textwidth,keepaspectratio]{images/PM_stages/pm_stages_3.eps}
        \caption{Voigt lineshape}
        \label{fig:PM_stages:B0 inhomogeneities}\vspace{0.2\baselineskip}
    \end{subfigure}\\[25pt]
    \begin{subfigure}[c]{0.315\textwidth}
        \includegraphics[width=0.95\textwidth,keepaspectratio]{images/PM_stages/pm_stages_4.eps}
        \caption{Residual Water}
        \label{fig:PM_stages:lineshape}\vspace{0.2\baselineskip}
    \end{subfigure}&
    \begin{subfigure}[c]{0.315\textwidth}
        \includegraphics[width=0.95\textwidth,keepaspectratio]{images/PM_stages/pm_stages_5.eps}
        \caption{Baseline}
        \label{fig:PM_stages:phi1}\vspace{0.2\baselineskip}
    \end{subfigure}&
    \begin{subfigure}[c]{0.315\textwidth}
        \includegraphics[width=0.95\textwidth,keepaspectratio]{images/PM_stages/pm_stages_6.eps}
        \caption{Frequency Shift}
        \label{fig:PM_stages:phi0}\vspace{0.2\baselineskip}\vspace{0.2\baselineskip}
    \end{subfigure}\\[25pt]
    \begin{subfigure}[c]{0.315\textwidth}
        \includegraphics[width=0.95\textwidth,keepaspectratio]{images/PM_stages/pm_stages_7.eps}
        \caption{Eddy currents}
        \label{fig:PM_stages:fshift}\vspace{0.2\baselineskip}
    \end{subfigure}&
    \begin{subfigure}[c]{0.315\textwidth}
        \includegraphics[width=0.95\textwidth,keepaspectratio]{images/PM_stages/pm_stages_8.eps}
        \caption{Noise}
        \label{fig:PM_stages:SNR}\vspace{0.2\baselineskip}
    \end{subfigure}&
    \begin{subfigure}[c]{0.315\textwidth}
        \includegraphics[width=0.95\textwidth,keepaspectratio]{images/PM_stages/pm_stages_9.eps}
        \caption{First-order phase}
        \label{fig:PM_stages:residual water}\vspace{0.2\baselineskip}
    \end{subfigure}\\[25pt]
    \begin{subfigure}[c]{0.315\textwidth}
        \includegraphics[width=0.95\textwidth,keepaspectratio]{images/PM_stages/pm_stages_10.eps}
        \vspace{0.5pt}
        \caption{Zero-order phase}
        \label{fig:PM_stages:baseline}
    \end{subfigure}&
    \begin{subfigure}[c]{0.315\textwidth}
        \includegraphics[width=0.95\textwidth,keepaspectratio]{images/PM_stages/pm_stages_11.eps}
        \vspace{0.5mm}
        \caption{Generated spectrum}
        \label{fig:PM_stages:generated spectrum}
    \end{subfigure}&
    \begin{subfigure}[c]{0.315\textwidth}
        \includegraphics[width=0.95\textwidth,keepaspectratio]{images/PM_stages/pm_stages_12.eps} \smallskip
        \caption{Pre-processed spectrum}
        \label{fig:PM_stages:corrected}
    \end{subfigure}
    \end{tabular}
    \caption{This is a step-by-step progression through the physics model. The real and imaginary components are \DIFaddbeginFL \DIFaddFL{depicted }\DIFaddendFL in black and \DIFdelbeginFL \DIFdelFL{grey}\DIFdelendFL \DIFaddbeginFL \DIFaddFL{gray}\DIFaddendFL , respectively. The red line includes only the metabolites and the offsets from the \DIFdelbeginFL \DIFdelFL{preceeding }\DIFdelendFL \DIFaddbeginFL \DIFaddFL{preceding }\DIFaddendFL steps. \ref{fig:PM_stages:generated spectrum} \DIFdelbeginFL \DIFdelFL{is }\DIFdelendFL \DIFaddbeginFL \DIFaddFL{shows }\DIFaddendFL the final spectrum with all artifacts applied. \ref{fig:PM_stages:corrected} is the pre-processed spectrum with the phase and frequency shifts removed.}
    \label{fig:PM compilation}
\end{figure}


\subsubsection{Basis Functions}
MRI, and its derivatives, are spatially resolved imaging modalities. \DIFdelbegin \DIFdel{Even singular pixels in MRI images represent a }\DIFdelend \DIFaddbegin \DIFadd{MR pixels and voxels represent }\DIFaddend 3D \DIFdelbegin \DIFdel{volume }\DIFdelend \DIFaddbegin \DIFadd{volumes }\DIFaddend with a spatial distribution, as shown in Fig. \ref{fig:spatial voxel}\DIFdelbegin \DIFdel{. Addressing this spatial component is important when working with quantitative MR modalities like spectroscopy. Inaccurately simulated basis functions cause errors in metabolite quantification when fitting in vivo data. With simulated data, such basis functions negatively impact the realism of the simulations, limiting their usefulness, especially for validating quantitative methods. }%DIFDELCMD < 

%DIFDELCMD < %%%
\DIFdelend \DIFaddbegin \DIFadd{, and needs to be accounted for in simulations. }\DIFaddend The importance of \DIFdelbegin \DIFdel{considering }\DIFdelend spatial localization led to \DIFaddbegin \DIFadd{selecting }\DIFaddend Landheer \etal's \DIFdelbegin \DIFdel{MARSS}\DIFdelend \DIFaddbegin \DIFadd{Magnetic Resonance Spectrum Simulator (MARSS)}\DIFaddend \cite{Landheer2021} software package \DIFdelbegin \DIFdel{being selected for }\DIFdelend \DIFaddbegin \DIFadd{for simulating }\DIFaddend the default basis functions provided with this simulator. MARSS produces high-fidelity outputs by simulating 128 points in each direction\DIFdelbegin \DIFdel{. This very accurately captures }\DIFdelend \DIFaddbegin \DIFadd{, accurately capturing }\DIFaddend the spatial nature of \DIFdelbegin \DIFdel{MR imaging. MARSS has }\DIFdelend \DIFaddbegin \DIFadd{the RF pulses and slice-selective gradients. Using vendor-specific pulse sequences, MARSS can simulate individual or summed spins for }\DIFaddend a large number of common brain metabolites \DIFdelbegin \DIFdel{already defined in their template files. Vendor-specific basis functions for these metabolites can be simulated with PRESS and STEAM sequences. Custom basis functions can also be simulated with various metabolites, T1 and T2 relaxations, and specialized pulse sequences, e.g. editing sequences, (semi-)Laser, etc.}\DIFdelend \DIFaddbegin \DIFadd{including macromolecules and lipids.%DIF >  vendor-specific basis functions making it easy to use for new simulations. 
%DIF >  The default basis functions are stored as individual spins for each metabolite allowing fine-detailed artifacts to be included. %for these metabolites can be simulated with PRESS and STEAM sequences. Custom basis functions can also be simulated with various metabolites, T1 and T2 relaxations, and specialized pulse sequences, e.g. editing sequences, (semi-)LASER, etc.
 }\DIFaddend 

\DIFdelbegin %DIFDELCMD < \begin{figure}[t]
%DIFDELCMD <     %%%
\DIFdelendFL \DIFaddbeginFL \begin{figure}[b]
    \DIFaddendFL \centering
    \begin{tabular}[b]{>{\centering}b{0.315\textwidth}>{\centering}b{0.315\textwidth}>{\centering}b{0.315\textwidth}}
        \centering
        \begin{subfigure}[c]{0.315\textwidth}
            \centering
            \includegraphics[width=5cm,keepaspectratio]{images/spatial_localization.eps}
            \caption{Intravoxel localization}
            \label{fig:spatial voxel}
        \end{subfigure} & 
        \begin{subfigure}[c]{0.315\textwidth}
            \centering
\DIFdelbeginFL %DIFDELCMD < \includegraphic[width=5cm,keepaspectratio]{images/B0_inhomogeneity_cube.eps}
%DIFDELCMD < %%%
\DIFdelendFL %            \def\svgwidth{5cm}
%DIF <              \input{images/B0_inhomogeneity_cube.eps_tex}
            %DIF >             \input{
            \DIFaddbeginFL \includegraphics[width=5cm,keepaspectratio]{images/B0_inhomogeneity_cube.eps_tex}
            \DIFaddendFL \caption{Intravoxel spatial distribution of $B_0$ with minor distortions}
            \label{fig:spatial B0}
        \end{subfigure} &
        \begin{subfigure}[c]{0.315\textwidth}
            \centering
\DIFdelbeginFL %DIFDELCMD < \includegraphic[width=5cm,keepaspectratio]{images/B0_inhomogeneity_cube_severe_distortion.eps}
%DIFDELCMD < %%%
\DIFdelendFL %            \def\svgwidth{5cm}
%DIF <              \input{images/B0_inhomogeneity_cube_severe_distortion.eps_tex}
            %DIF >             \input{
            \DIFaddbeginFL \includegraphics[width=5cm,keepaspectratio]{images/B0_inhomogeneity_cube_severe_distortion.eps_tex}
            \DIFaddendFL \caption{Spatial distribution of $B_0$ with major distortions}
            \label{fig:spatial B0 severe}
        \end{subfigure}
    \end{tabular}
    \caption{Voxels are often treated as singularities, meaning the entire volume is considered to be single point like the red box in the center. Accounting for these intravoxel distributions leads to more accurate and more realistic simulations. \ref{fig:spatial voxel} highlights the spatial nature of voxels while \ref{fig:spatial B0} and \ref{fig:spatial B0 severe} show different levels of intravoxel $B_0$ inhomogeneity.}
    \label{fig:intravoxel localization}
\end{figure}

 
\DIFdelbegin \paragraph{\DIFdel{Macromolecules and Lipids}}
%DIFAUXCMD
\addtocounter{paragraph}{-1}%DIFAUXCMD
\DIFdel{Current spectral fitting methods for modeling MM and lipid signals are based on creating a group of curves that resemble clinical data but are not informed by any underlying physical phenomenon. Each fitting package contains their own set of basis functions for modeling these regions. Until this knowledge gap is filled in, this work uses pre-generated basis functions from Osprey\mbox{%DIFAUXCMD
\cite{Oeltzschner2020} }\hspace{0pt}%DIFAUXCMD
that were resampled to match the simulated basis functions from MARSS.
 }\DIFdelend %DIF >  \paragraph{Macromolecules and Lipids}
%DIF >  Current spectral fitting methods for modeling MM and lipid signals are based on creating a group of curves that resemble clinical data but are not informed by any underlying physical phenomenon. Each fitting package contains their own set of basis functions for modeling these regions. Until this knowledge gap is filled and better simulation methods are developed, this work will use pre-generated basis functions from Osprey\cite{Oeltzschner2020}.% that were resampled to match the simulated basis functions from MARSS.

\subsubsection{Amplitude Modulation}
\DIFdelbegin \DIFdel{Metabolite quantities produced during spectral fitting are of an arbitrary scale. Comparing these quantities with a standard reference puts them into context. In vivo proton scans generally use an internal reference metabolite for relative quantification. Creatine is the default metabolite because its concentration is relatively stable. As a result, concentrations maps are generally reported as ratios with respect to creatine and all amplitude values in this model are defined }\textit{\DIFdel{wrt}} %DIFAUXCMD
\DIFdel{creatine as the default. }\DIFdelend For this framework, \DIFdelbegin \DIFdel{physiological values were derived from work by Das }%DIFDELCMD < \etal%%%
\DIFdel{\mbox{%DIFAUXCMD
\cite{Das2017,Das2018}}\hspace{0pt}%DIFAUXCMD
. These ranges were then expanded to include values observed in clinical scans from a private glioma dataset. In keeping in line with the LCModel, the expected concentrations ranges represent the scaling factors needed for spectral fitting instead of }\DIFdelend \DIFaddbegin \DIFadd{comprehensive ranges including physiological and pathological values were adapted from }\DIFaddend the \DIFdelbegin \DIFdel{ratios of peak integrals or peak heights.
}\DIFdelend \DIFaddbegin \DIFadd{meta-analysis by Gudmundson }\etal\DIFadd{\mbox{%DIFAUXCMD
\cite{Gudmundson2023} }\hspace{0pt}%DIFAUXCMD
and are presented in the appendix. Near\mbox{%DIFAUXCMD
\cite{Near2021} }\hspace{0pt}%DIFAUXCMD
and Larsen\mbox{%DIFAUXCMD
\cite{Larsen2021} }\hspace{0pt}%DIFAUXCMD
discuss how non-trivial the choice of reference metabolite is with respect to quantification and interpretability. Therefore, the default ranges are in units of milimolar (mM) which allows any reference to be used. More specific information can be found in the MARSS user manual.
%DIF >  Metabolite quantities produced during spectral fitting are of an arbitrary scale. Comparing these quantities with a standard reference puts them into context. In vivo proton scans generally use an internal reference metabolite for relative quantification. Creatine is the default metabolite because its concentration is relatively stable. As a result, concentrations maps are generally reported as ratios with respect to creatine and all amplitude values in this model are defined \textit{wrt} creatine as the default. For this framework, comprehensive ranges including physiological and pathological values were adapted from the meta-analysis by Gudmundson \etal\cite{Gudmundson2023}. 
%DIF > These ranges were then expanded to include values observed in in vivo scans from a private glioma dataset. In keeping in line with the LCModel, the expected concentrations ranges represent the scaling factors needed for spectral fitting instead of the ratios of peak integrals or peak heights.
 }\DIFaddend 

\subsubsection{Lineshape Profiles}\DIFdelbegin \DIFdel{In spectral fitting, the }\DIFdelend \DIFaddbegin \label{subsubsec:lineshapes}
\DIFadd{The }\DIFaddend Voigt lineshape profile is the most commonly used \DIFaddbegin \DIFadd{in spectral fitting }\DIFaddend as it most closely matches \DIFdelbegin \DIFdel{clinical data.
}\DIFdelend \DIFaddbegin \DIFadd{in vivo data.
%DIF >  In spectral fitting, the Voigt lineshape profile is the most commonly used as it most closely matches clinical data. 
}\DIFaddend It is a combination of a Lorentzian and a Gaussian and is used \DIFaddbegin \DIFadd{in }\DIFaddend various fitting packages, such as LCModel\cite{Provencher2001}, TARQUIN\cite{Wilson2011}, jMRUI\cite{Stefan2009}, and Osprey\cite{Oeltzschner2020}. \DIFdelbegin \DIFdel{Each peak is characterized by an individual }\DIFdelend \DIFaddbegin \DIFadd{For completeness, it is also possible to specify either a purely Lorentzian or a purely Gaussian lineshape. 
Individual Lorentzian and Gaussian values can be assigned to each moiety or metabolite separately, depending on the desired level of granularity. At the most basic level, each metabolite is assigned a }\DIFaddend Lorentzian value while a single Gaussian value is applied to the \DIFdelbegin \DIFdel{metabolites, while }\DIFdelend \DIFaddbegin \DIFadd{set of metabolites and }\DIFaddend a second value can be applied to the macromolecules and lipids. Standard practice from the aforementioned software packages \DIFdelbegin \DIFdel{assigns }\DIFdelend \DIFaddbegin \DIFadd{assign }\DIFaddend a single Lorentzian value to each metabolite, instead of each moiety. \DIFdelbegin \DIFdel{However, experimental results from Wyss }%DIFDELCMD < \etal%%%
\DIFdel{\mbox{%DIFAUXCMD
\cite{Wyss2018} }\hspace{0pt}%DIFAUXCMD
can be selected which characterized }\DIFdelend \DIFaddbegin \DIFadd{It is also possible to specify moiety-level }\DIFaddend T2 relaxation values \DIFdelbegin \DIFdel{at the moiety-level for various brain metabolites at 3T in three different regions in the brain}\DIFdelend \DIFaddbegin \DIFadd{for selected metabolites from Wyss }\etal\DIFadd{\mbox{%DIFAUXCMD
\cite{Wyss2018}}\hspace{0pt}%DIFAUXCMD
. 
%DIF >  However, experimental results from Wyss \etal\cite{Wyss2018} can be used, which characterized moiety-level T2 relaxation values for metabolites in three brain regions at 3T. 
Information is %DIF > for some metabolites can be 
supplemented by the meta-analysis from Gudmundson }\etal\DIFadd{\mbox{%DIFAUXCMD
\cite{Gudmundson2023}}\hspace{0pt}%DIFAUXCMD
}\DIFaddend . As more metabolites are characterized, new information can be added to the model. \DIFdelbegin \DIFdel{For completeness, it is also possible to specify either a purely Lorentzian or a purely Gaussian lineshape.
 }\DIFdelend \DIFaddbegin \DIFadd{A detailed table is provided in the appendix with the current information; however, an up-to-date digital version will be maintained in the repository.
 }\DIFaddend 

\DIFdelbegin \subsubsection{\DIFdel{$B_0$ Inhomogeneities}}
%DIFAUXCMD
\addtocounter{subsubsection}{-1}%DIFAUXCMD
\DIFdel{Lower and higher order shimming procedures homogenize the magnetic field in the target volume to different degrees.
 However, certain regions of the brain, such as the prefrontal cortex or deep brain structures like the thalamus or basal ganglia, are more difficult to shim and therefore suffer from large magnetic susceptibility effects, resulting in significant lineshape distortions}\DIFdelend \DIFaddbegin \subsubsection{\DIFadd{B\textsubscript{0} Inhomogeneities}}
%DIF >  Lower and higher order shimming procedures homogenize the magnetic field in the target volume to different degrees. However, certain regions of the brain, such as the prefrontal cortex or deep brain structures like the thalamus or basal ganglia, are more difficult to shim and therefore suffer from large magnetic susceptibility effects, resulting in significant lineshape distortions. Fig. \ref{fig:spatial B0} shows the normal, subtle $B_0$ changes across the volume of a spectroscopy voxel while Fig. \ref{fig:spatial B0 severe} illustrates these high susceptibility effects. In such cases, spectra from these regions exhibit significant lineshape distortions which cannot be adequately characterized using idealized lineshape profiles. Fig. \ref{fig:B0 effects} shows the result of high susceptibility effects on lineshapes.

%DIF >  \input{figures/fig:b0_peaks}

\DIFadd{Small $B_0$ inhomogeneities are, in general, sufficiently modeled by the Gaussian term of the Voigt lineshape. However, to simulate more severe distortions from large inhomogeneities, a $B_0$ field volume needs to be modeled and applied to the basis functions. Fig. \ref{fig:intravoxel localization} illustrates the difference between small and severe $B_0$ inhomogeneities}\DIFaddend . Fig. \ref{fig:spatial B0} shows the normal, subtle $B_0$ changes across the volume of a spectroscopy voxel while Fig. \ref{fig:spatial B0 severe} illustrates these high susceptibility effects. In such cases, spectra from these regions exhibit significant lineshape distortions \DIFdelbegin \DIFdel{which }\DIFdelend \DIFaddbegin \DIFadd{that }\DIFaddend cannot be adequately characterized using idealized lineshape profiles. Fig. \ref{fig:B0 effects} shows the result of high susceptibility effects on lineshapes.

\begin{figure}
    \centering
    \begin{subfigure}{0.32\textwidth}
        \centering
        \includegraphics[width=0.95\textwidth,keepaspectratio]{images/b0_peaks/no_B0.eps}
        \caption{Spectral peaks without $B_0$ inhomogeneities ($\mu = 0$Hz)}
        \label{subfig:without B0}        
    \end{subfigure}
    \begin{subfigure}{0.32\textwidth}
        \centering
        \includegraphics[width=0.95\textwidth,keepaspectratio]{images/b0_peaks/some_B0.eps}
        \caption{Spectral peaks with moderate $B_0$ inhomogeneities ($\mu = 75$Hz)}
        \label{subfig:some B0}        
    \end{subfigure}
    \begin{subfigure}{0.32\textwidth}
        \centering
        \includegraphics[width=0.95\textwidth,keepaspectratio]{images/b0_peaks/with_B0.eps}
        \caption{Spectral peaks with severe $B_0$ inhomogeneities ($\mu = 175$Hz)}
        \label{subfig:with B0}        
    \end{subfigure}
    \caption{These samples show the effects that can be modeled using the 3D $B_0$ field simulator. In \ref{subfig:without B0}, the spectral peaks have a purely Lorentzian lineshape. In \ref{subfig:some B0}, the lineshape is now Voigtian because the Gaussian term has been added back by the 3D $B_0$ field simulator. In \ref{subfig:with B0}, severe heterogeneities are modeled which produce extremely broad line widths. All three plots use the same x- and y-axes. The observed offsets are caused by the line broadening.}
    \label{fig:B0 effects}
\end{figure}


\DIFdelbegin \DIFdel{Small $B_0$ inhomoegeneities are, in general, sufficiently modeled by the Gaussian term of the Voigt lineshape. However, to simulate more severe distortions, a $B_0$ field volume needs to be modeled and applied to the basis functions. }\DIFdelend In general, this approach mirrors Li \etal\cite{Li2015} \DIFdelbegin \DIFdel{, but }\DIFdelend \DIFaddbegin \DIFadd{in which the basis functions are modulated by the $B_0$ field map, but in the implementation }\DIFaddend the $B_0$ field map is simulated rather than acquired. As with MARSS, Li \etal\DIFaddbegin \DIFadd{\mbox{%DIFAUXCMD
\cite{Li2015}}\hspace{0pt}%DIFAUXCMD
}\DIFaddend \ \DIFdelbegin \DIFdel{suggests }\DIFdelend \DIFaddbegin \DIFadd{suggest }\DIFaddend using multiple points in each direction instead of a single value per voxel. The exact number of points used in each direction is described by the size of the spectroscopy voxel divided by the size of an anatomical imaging voxel. \DIFdelbegin \DIFdel{The default values assume sizes of 10cm$^3$ and 0.5cm$^3$ respectively, which results in $20^3$ simulation points. However, any }\DIFdelend %DIF > The default values assume sizes of 10cm$^3$ and 0.5cm$^3$ respectively, which results in $20^3$ simulation points. 
%DIF >  However, a
\DIFaddbegin \DIFadd{Any }\DIFaddend cuboidal shape, rectangular or otherwise, can be modeled. The $B_0$ field is defined by four variables\DIFdelbegin \DIFdel{, all of which are mean offsets}\DIFdelend : $\pm dx$, $\pm dy$, $\pm dz$, and $\mu$. $dx, dy,$ and $dz$ describe half of the change in $B_0$ in their respective \DIFdelbegin \DIFdel{direction }\DIFdelend \DIFaddbegin \DIFadd{axis }\DIFaddend from the voxel's center and $\mu$ is the mean of the entire voxel. \DIFaddbegin \DIFadd{A linear $B_0$ gradient is assumed, but other shapes can be implemented. The first section in the supplement provides a more detailed explanation of how the $B_0$ is simulated.
}\DIFaddend 

\DIFdelbegin \subsubsection{\DIFdel{Baseline and Residual Water}}
%DIFAUXCMD
\addtocounter{subsubsection}{-1}%DIFAUXCMD
\DIFdelend %DIF >  Lower and higher order shimming procedures homogenize the magnetic field in the target volume to different degrees. However, certain regions of the brain, such as the prefrontal cortex or deep brain structures like the thalamus or basal ganglia, are more difficult to shim and therefore suffer from large magnetic susceptibility effects, resulting in significant lineshape distortions. Fig. \ref{fig:spatial B0} shows the normal, subtle $B_0$ changes across the volume of a spectroscopy voxel while Fig. \ref{fig:spatial B0 severe} illustrates these high susceptibility effects. In such cases, spectra from these regions exhibit significant lineshape distortions which cannot be adequately characterized using idealized lineshape profiles. Fig. \ref{fig:B0 effects} shows the result of high susceptibility effects on lineshapes.

\DIFdelbegin %DIFDELCMD < \begin{figure}[b!]
%DIFDELCMD <     %%%
\DIFdelendFL %DIF >  \input{figures/fig:b0_peaks}
\DIFaddbeginFL 

%DIF >  Small $B_0$ inhomoegeneities are, in general, sufficiently modeled by the Gaussian term of the Voigt lineshape. However, to simulate more severe distortions, a $B_0$ field volume needs to be modeled and applied to the basis functions. In general, this approach mirrors Li \etal\cite{Li2015}, but the $B_0$ field map is simulated rather than acquired. As with MARSS, Li \etal\ suggests using multiple points in each direction instead of a single value per voxel. The exact number of points used in each direction is described by the size of the spectroscopy voxel divided by the size of an anatomical imaging voxel. The default values assume sizes of 10cm$^3$ and 0.5cm$^3$ respectively, which results in $20^3$ simulation points. However, any cuboidal shape, rectangular or otherwise, can be modeled. The $B_0$ field is defined by four variables, all of which are mean offsets: $\pm dx$, $\pm dy$, $\pm dz$, and $\mu$. $dx, dy,$ and $dz$ describe half of the change in $B_0$ in their respective direction from the voxel's center and $\mu$ is the mean of the entire voxel. 

\begin{figure}[ht!]
    \DIFaddendFL \centering
    \begin{tabular}[l]{cc}
    \begin{subfigure}{0.49\textwidth}
        \centering
        \includegraphics[width=0.95\textwidth,keepaspectratio]{images/random_walks/baseline_walks_edited.eps}
        \caption{Simulated baselines}
        \label{fig:baseline_region}
    \end{subfigure} &

    \begin{subfigure}{0.49\textwidth}
        \centering
        \includegraphics[width=0.95\textwidth,keepaspectratio]{images/random_walks/reswater_walks_edited.eps}
        \caption{Simulated residual water}
        \label{fig:reswater_region}
    \end{subfigure}
    \end{tabular}
    \caption{Simulated  samples of spectral baselines and residual water regions using the pseudo-random bounded walk generator. The blue lines are the raw simulations. The red lines are the smoothed versions that are then returned and applied to the simulated spectra.}
    \label{fig:random walk generator}
\end{figure}

\DIFaddbegin \begin{algorithm}[b!]
\caption{\DIFadd{Smoothed Bounded Pseudo-Random Walk}} \label{alg:smoothed bounded pseudo-random walk}
\begin{algorithmic}[1]
\Require \DIFadd{$start$: ppm start value, $end$: ppm end value, $std$: standard deviation of the random noise, $lower\_bound$: lower bound of the walk, $upper\_bound$: upper bound of the walk, $length$: length of the walk
%DIF >  \Ensure $rand\_walk$: bounded pseudo-random walk
}\end{algorithmic}

\textbf{\DIFadd{Function}} \DIFadd{SmoothedBoundedPseudoRandomWalk($start, end, std, lower\_bound, upper\_bound, length, window\_size$)
%DIF >  \Function{BoundedPseudoRandomWalk}{$start, end, std, lower\_bound, upper\_bound, length$}
}\begin{algorithmic}[1]
\State \DIFadd{$bounds = upper\_bound - lower\_bound$
}\Statex \DIFadd{Generate raw random walk
}\State \DIFadd{$rand = \text{generate\_random\_array}(size=length, std=std)$
}\State \DIFadd{$rand = \text{cumsum}(rand, dim=-1)$
}

\Statex \DIFadd{Calculate the trend line
}\State \DIFadd{$rand\_trend\_lines = \text{generate\_trend\_array}(start, end, length)$
}

\Statex \DIFadd{Calculate the difference between the random steps and the trend line
}\State \DIFadd{$rand\_deltas = rand - rand\_trend\_lines$
}\Statex \DIFadd{Normalize the delta array
}\State \DIFadd{$delta\_range = bounds \div (rand\_deltas.max() - rand\_deltas.min())$
}\State \DIFadd{$rand\_deltas = rand\_deltas * delta\_range$
}

\Statex \DIFadd{Adjust delta array if it exceeds }\textit{\DIFadd{bounds}}
\State \DIFadd{$rand\_deltas = conditional\_adjustment(rand\_deltas)$
}\Statex \DIFadd{Calculate the final random walk
}\State \DIFadd{$random\_walk = trend\_lines + rand\_deltas$
}

\Statex \DIFadd{Smooth using a uniform smoothing kernel
%DIF >  \State $kernel\_size $
}\State \DIFadd{$random\_walk = \text{average\_smoothing}(random\_walk, kernel\_size=window\_size * length)$
}

\Statex \Return \DIFadd{$random\_walk$ %DIF > trend\_lines + rand_deltas$
%DIF >  \EndFunction
}\end{algorithmic}
\end{algorithm}

 
\subsubsection{\DIFadd{Baseline and Residual Water}}\label{sec:methods:subsubsec:baseline}


\DIFaddend Currently, the underlying physical phenomena that induce spectral baseline offsets are poorly understood. In fact, there is no physics-based model for simulating these offsets. Similarly, the residual water region is also poorly characterized. Therefore, a naive random model can be used in conjunction with \DIFdelbegin \DIFdel{clinically }\DIFdelend observed constraints to approximate what is \DIFdelbegin \DIFdel{observed }\DIFdelend \DIFaddbegin \DIFadd{expected }\DIFaddend in vivo. This work proposes a smoothed, pseudo-random, bounded walk generator for both the broad spectral baseline and the more irregular residual water region. The approach is elaborated on in Algorithm \ref{alg:smoothed bounded pseudo-random walk}. Customizable profiles were developed for each artifact to more closely approximate what is expected in vivo. Immense variety of outputs can be achieved by randomly sampling the parameters from distributions instead of \DIFdelbegin \DIFdel{fixing them to set }\DIFdelend \DIFaddbegin \DIFadd{using fixed }\DIFaddend values. Once simulated, they are resampled to match the ppm range of acquired data and the order of magnitude is matched to the spectra. The Hilbert transform is then used to generate the corresponding complex component before being added to the FID. As shown in Fig. \ref{fig:random walk generator}, this generator produces very different outputs depending on the specified configurations. Fig. \ref{fig:baseline_region} shows very broad, smooth lines while Fig. \ref{fig:reswater_region} shows highly irregular lines that closely resemble residual water regions. All outputs are then scaled to modulate the impact on the final spectra. A more detailed exploration of this algorithm and the effects of each parameter are presented in the supplement for baseline and residual water simulations.

\DIFdelbegin %DIFDELCMD < \begin{algorithm}[t!]
%DIFDELCMD < %%%
%DIFDELCMD < \caption{%
{%DIFAUXCMD
\DIFdel{Smoothed Bounded Pseudo-Random Walk}} %DIFAUXCMD
%DIFDELCMD < \label{alg:smoothed bounded pseudo-random walk}
%DIFDELCMD < \begin{algorithmic}[1]
%DIFDELCMD < \Require %%%
\DIFdel{$start$: ppm start value, $end$: ppm end value, $std$: standard deviation of the random noise, $lower\_bound$: lower bound of the walk, $upper\_bound$: upper bound of the walk, $length$: length of the walk
%DIF <  \Ensure $rand\_walk$: bounded pseudo-random walk
}%DIFDELCMD < \end{algorithmic}
%DIFDELCMD < 

%DIFDELCMD < %%%
\textbf{\DIFdel{Function}} %DIFAUXCMD
\DIFdel{SmoothedBoundedPseudoRandomWalk($start, end, std, lower\_bound, upper\_bound, length, window\_size$)
%DIF <  \Function{BoundedPseudoRandomWalk}{$start, end, std, lower\_bound, upper\_bound, length$}
}%DIFDELCMD < \begin{algorithmic}[1]
%DIFDELCMD < \State %%%
\DIFdel{$bounds = upper\_bound - lower\_bound$
}%DIFDELCMD < \Statex %%%
\DIFdel{Generate raw random walk
}%DIFDELCMD < \State %%%
\DIFdel{$rand = \text{generate\_random\_array}(size=length, std=std)$
}%DIFDELCMD < \State %%%
\DIFdel{$rand = \text{cumsum}(rand, dim=-1)$
}%DIFDELCMD < 

%DIFDELCMD < \Statex %%%
\DIFdel{Calculate the trend line
}%DIFDELCMD < \State %%%
\DIFdel{$rand\_trend\_lines = \text{generate\_trend\_array}(start, end, length)$
}%DIFDELCMD < 

%DIFDELCMD < \Statex %%%
\DIFdel{Calculate the difference between the random steps and the trend line
}%DIFDELCMD < \State %%%
\DIFdel{$rand\_deltas = rand - rand\_trend\_lines$
}%DIFDELCMD < \Statex %%%
\DIFdel{Normalize the delta array
}%DIFDELCMD < \State %%%
\DIFdel{$delta\_range = bounds \div (rand\_deltas.max() - rand\_deltas.min())$
}%DIFDELCMD < \State %%%
\DIFdel{$rand\_deltas = rand\_deltas * delta\_range$
}%DIFDELCMD < 

%DIFDELCMD < \Statex %%%
\DIFdel{Adjust delta array if it exceeds }\textit{\DIFdel{bounds}}
%DIFAUXCMD
%DIFDELCMD < \State %%%
\DIFdel{$rand\_deltas = conditional\_adjustment(rand\_deltas)$
}%DIFDELCMD < \Statex %%%
\DIFdel{Calculate the final random walk
}%DIFDELCMD < \State %%%
\DIFdel{$random\_walk = trend\_lines + rand\_deltas$
}%DIFDELCMD < 

%DIFDELCMD < \Statex %%%
\DIFdel{Smooth using a uniform smoothing kernel
%DIF <  \State $kernel\_size $
}%DIFDELCMD < \State %%%
\DIFdel{$random\_walk = \text{average\_smoothing}(random\_walk, kernel\_size=window\_size * length)$
}%DIFDELCMD < 

%DIFDELCMD < \Statex \Return %%%
\DIFdel{$random\_walk$ %DIF < trend\_lines + rand_deltas$
%DIF <  \EndFunction
}%DIFDELCMD < \end{algorithmic}
%DIFDELCMD < \end{algorithm}
%DIFDELCMD < %%%
\DIFdelend %DIF >  \input{algorithms/alg:bounded_random_walk}

\subsubsection{Noise}
The noise in this model assumes a Gaussian distribution. The input SNR is first converted from decibels to a linear SNR. Then the standard deviation for this distribution is calculated using the maximum height of a metabolite of choice in the real spectrum and the desired SNR. The real and imaginary components of the noise can be correlated using the Hilbert transform. If they are assumed to be uncorrelated, then separate noise vectors are sampled for each component. 

\subsubsection{Phase Offsets}
%DIF >  There are two types of phase offsets encountered in MRS: zero-order and first-order. FIDs and spectra are complex data type consisting of real and imaginary components. A $0^{\circ}$ zero-order phase offset results in absorption and dispersion spectra in these components, respectively. An absorption spectrum exhibits peaks with idealized lineshapes that are purely positive or purely negative, while dispersion spectra exhibit peaks that are both positive and negative. As shown in Fig. \ref{fig:phase effects}, non-zero degree offsets result in a mixture of absorption and dispersion spectra.
\paragraph{Zero-Order Phase}
FIDs and spectra are complex data types \DIFdelbegin \DIFdel{which consist of a }\DIFdelend \DIFaddbegin \DIFadd{consisting of }\DIFaddend real and imaginary \DIFdelbegin \DIFdel{component}\DIFdelend \DIFaddbegin \DIFadd{components}\DIFaddend . A $0^{\circ}$ zero-order phase offset results in absorption and dispersion spectra in these components, respectively. An absorption spectrum exhibits peaks with idealized lineshapes that are purely positive or purely negative, while dispersion spectra exhibit peaks that are both positive and negative. As shown in Fig. \ref{fig:phase effects}, non-zero degree offsets result in a mixture of absorption and dispersion spectra. \DIFdelbegin \DIFdel{In absorption mode, spectral peaks directly reflect the number of hydrogens of that species and the concentration of that molecule. This relationship means that the phase has a direct impact on metabolite quantification. 
 }\DIFdelend %DIF > In absorption mode, spectral peaks directly reflect the number of hydrogens of that species and the concentration of that molecule. This relationship means that the phase has a direct impact on metabolite quantification. 

\paragraph{First-Order Phase}
First-order phase, i.e. linear phase, is a frequency-dependent \DIFaddbegin \DIFadd{linear }\DIFaddend offset that emanates from a reference point, i.e. the center frequency\DIFaddbegin \DIFadd{, }\DIFaddend which is typically the water peak at 4.65ppm\DIFdelbegin \DIFdel{but can be modified when necessary. It carries the unit degrees per ppm. }\DIFdelend \DIFaddbegin \DIFadd{. %DIF > but can be modified when necessary. 
}\DIFaddend A linear phase offset creates asymmetrical line shapes that grow larger as one moves away from the reference point. \DIFaddbegin \DIFadd{This is illustrated in Fig. \ref{fig:phase effects} by comparing \ref{subfig:no phase} and \ref{subfig:first order phase}. %DIF > It is specified as degrees per ppm. 
}\DIFaddend 

\DIFdelbegin %DIFDELCMD < \begin{figure}
%DIFDELCMD <     %%%
\DIFdelendFL \DIFaddbeginFL \begin{figure}[b!]
    \DIFaddendFL \centering
    \begin{subfigure}{0.32\textwidth}
        \centering
        \includegraphics[width=0.95\textwidth,keepaspectratio]{images/phase/no_phase.eps}
        \caption{Spectrum with no phase offsets}
        \label{subfig:no phase}        
    \end{subfigure}
    \begin{subfigure}{0.32\textwidth}
        \centering
        \includegraphics[width=0.95\textwidth,keepaspectratio]{images/phase/zero-order.eps}
        \caption{Spectrum with zero-order phase offset ($\phi_0 = 45^{\circ}$)}
        \label{subfig:zero order phase}        
    \end{subfigure}
    \begin{subfigure}{0.32\textwidth}
        \centering
        \includegraphics[width=0.95\textwidth,keepaspectratio]{images/phase/first-order.eps}
        \caption{Spectrum with first-order phase offset ($\phi_1 = 20^{\circ}$)}
        \label{subfig:first order phase}        
    \end{subfigure}
    \caption{These samples show how identical spectra are \DIFdelbeginFL \DIFdelFL{effected }\DIFdelendFL \DIFaddbeginFL \DIFaddFL{affected }\DIFaddendFL by zero- and first-order phase offsets. In \ref{subfig:no phase}, the real component (black) is in absorption mode exhibiting narrow line widths and is fully positive. In \ref{subfig:zero order phase}, a zero-order phase offset is applied. As the spectrum shifts from absorption to dispersion mode, the peaks uniformly lose their symmetry and negative values from the imaginary component are transferred to the real component. In \ref{subfig:first order phase}, a first-order phase shift is applied. This is evident because the asymmetry increases across the spectrum and emanates from the water peak.}
    \label{fig:phase effects}
\end{figure}

\subsubsection{Frequency Shifts}
\DIFdelbegin \DIFdel{Frequency shifts observed in a spectrum result from complex interactions with a variety of factors. During the }\DIFdelend %DIF >  Frequency shifts observed in a spectrum result from complex interactions with a variety of factors. 
\DIFaddbegin \DIFadd{During data }\DIFaddend acquisition, the FID experiences a global frequency shift. However, \DIFdelbegin \DIFdel{individual moieties from metabolites and nuisance signals from macromolecules, lipids, and fats such as diglycerides and triglycerides, }\DIFdelend \DIFaddbegin \DIFadd{some functional groups 
%DIF > individual moieties from metabolites and nuisance signals from macromolecules, lipids, and fats such as diglycerides and triglycerides, 
}\DIFaddend can experience individual frequency shifts which are attributed to \DIFaddbegin \DIFadd{effects such as }\DIFaddend temperature and pH\DIFdelbegin \DIFdel{effects. }%DIFDELCMD < 

%DIFDELCMD < %%%
\DIFdel{The current implementation allows each metabolite, or moeity depending on the simulation, to have a minor, }\DIFdelend \DIFaddbegin \DIFadd{. Similar to Sec. \ref{subsubsec:lineshapes}, the bare minimum requires separate global frequency shifts for the metabolites and nuisance signals. However, this model also allows each basis function to have an }\DIFaddend independent frequency shift in addition to the global shift which is in line with common spectral fitting protocols. For more \DIFdelbegin \DIFdel{clinically }\DIFdelend \DIFaddbegin \DIFadd{in vivo-like, }\DIFaddend realistic spectra, values can be used from the work by Wermter \etal\cite{Wermter2017} which characterized the temperature-induced frequency shift of \DIFaddbegin \DIFadd{several }\DIFaddend brain metabolite moieties with temperature sensitivity. As more metabolites are characterized for their temperature- and pH-sensitivities, this information can be added to simulate more realistic spectra. \DIFaddbegin \DIFadd{Currently available data will be included in the table in the appendix.
 }\DIFaddend 

\subsubsection{Eddy Currents}
\DIFdelbegin \DIFdel{Eddy currents are common artifacts in MRI acquisitions that are induced by changes in the magnetic field, typically caused by the imaging gradients and present as time-dependent resonant frequency shifts.
 Correction }\DIFdelend %DIF >  Eddy currents are common artifacts in MRI acquisitions that are induced by changes in the magnetic field, typically caused by the imaging gradients and present as time-dependent resonant frequency shifts. 
\DIFaddbegin \DIFadd{Eddy current correction }\DIFaddend techniques, such as the Klose\cite{Klose1990}, tend to be non-parameterized, making it difficult to model the exact effect of each approach. Near \etal\ in FID-A\cite{Simpson2017}, however, provide a parameterized equation for simulating first-order eddy currents. These artifacts are applied as a function of amplitude, $A$, time constant, $tc$, and time, $t$. The time constant must be short enough that it occurs entirely within the recorded echo, otherwise it will appear as a simple, global frequency shift. The effects of eddy currents can be seen in Fig. \ref{fig:eddy currents}.

\DIFdelbegin %DIFDELCMD < \begin{figure}[b]
%DIFDELCMD <     %%%
\DIFdelendFL \DIFaddbeginFL \begin{figure}[t]
    \DIFaddendFL \centering
    \begin{subfigure}{0.32\textwidth}
        \includegraphics[width=0.95\textwidth, keepaspectratio]{images/eddy/ec=1.eps}
        \caption{Eddy current amplitude = 1.0}
        \label{subfig:ec=1}        
    \end{subfigure}
    \begin{subfigure}{0.32\textwidth}
        \includegraphics[width=0.95\textwidth, keepaspectratio]{images/eddy/ec=3.eps}
        \caption{Eddy current amplitude = 3.0}
        \label{subfig:ec=3}        
    \end{subfigure}
    \begin{subfigure}{0.32\textwidth}
        \includegraphics[width=0.95\textwidth, keepaspectratio]{images/eddy/ec=5.eps}
        \caption{Eddy current amplitude = 5.0}
        \label{subfig:ec=5}        
    \end{subfigure}
    \caption{These 3 samples show the effect of eddy currents on MRS spectra to various degrees. The strength of the eddy currents increases from \ref{subfig:ec=1} to \ref{subfig:ec=5}. If the time constant, $tc$, is set too long, the eddy current artifact will appear as a global frequency shift. In these examples, it can be seen that only some frequencies are affected.}
    \label{fig:eddy currents}
\end{figure}


\subsubsection{Multi-Coil Transients}
\DIFdelbegin \DIFdel{A transient copy is made for each coil in the simulated scenario. 
These transients 
will }\DIFdelend \DIFaddbegin \DIFadd{When simulating transients, additional considerations need to be included. 
During acquisition, transients 
%DIF >  A transient copy is made for each coil in the simulated scenario. These transients will 
}\DIFaddend experience additional artifacts including zero-order phase and frequency drifts, scaling due to coil sensitivity, and decreased SNR values. \DIFaddbegin \DIFadd{Each of these are included in the proposed framework. }\DIFaddend To allow for maximum variation in the simulations, each parameter can be sampled from distributions and is discussed below.

\paragraph{Noise} \DIFdelbegin \DIFdel{Multi-coil acquisitions lead }\DIFdelend \DIFaddbegin \DIFadd{Averaging multi-coil acquisitions leads }\DIFaddend to an SNR improvement of the final spectrum by a factor of the square root of the number of non-zero weighted transients. To vary the SNR among the transients, this model scales the target linear SNR according to the number of coils and then samples scaling factors from a narrow normal distribution to maintain the mean target SNR. 

\paragraph{Frequency Drift and Phase Drift}
Frequency drifts and phase drifts are phenomena observed in multi-coil acquisitions in which each coil transient has an independent offset. \DIFdelbegin \DIFdel{Transients’ lower SNRs make it harder to correct accurately. Therefore, drifts are typically minimized between the transients, called alignment. Proper alignment will preserve the underlying spectral features once the transients are combined. }\DIFdelend %DIF > The lower SNR values of the transients make it harder to accurately correct these inter-transient variations. Therefore, drifts are typically minimized between the transients, called alignment. Proper alignment will preserve the underlying spectral features once the transients are combined.
These offsets and alignments are shown in Fig. \ref{fig:simulated transients}.

\DIFdelbegin %DIFDELCMD < \begin{figure}[t]
%DIFDELCMD <     %%%
\DIFdelendFL \DIFaddbeginFL \begin{figure}[b!]
    \DIFaddendFL \centering
    \begin{subfigure}{0.32\textwidth}
        \includegraphics[width=0.95\textwidth, keepaspectratio]{images/samples_transients/8coil_w_phase_w_fshift_cropped.eps}
        \caption{Raw spectral transients}
        \label{subfig:raw transients}        
    \end{subfigure}
    \begin{subfigure}{0.32\textwidth}
        \includegraphics[width=0.95\textwidth, keepaspectratio]{images/samples_transients/8coil_wo_phase_w_fshift_cropped.eps}
        \caption{Phase alignment}
        \label{subfig:phase alignment}        
    \end{subfigure}
    \begin{subfigure}{0.32\textwidth}
        \includegraphics[width=0.95\textwidth, keepaspectratio]{images/samples_transients/8coil_wo_phase_wo_fshift_cropped.eps}
        \caption{Frequency alignment}
        \label{subfig:frequency alignment}        
    \end{subfigure}
    \caption{Examples of 8 simulated coil transients for a 3T GE PRESS sequence with TE=30ms. \ref{subfig:raw transients} shows transients with various SNRs and coil sensitivities along with zero-order phase and frequency offsets. \ref{subfig:phase alignment} shows the transients after phase alignment. \ref{subfig:frequency alignment} shows the transients after frequency alignment. After \ref{subfig:frequency alignment}, the transients can be averaged together and the coil-combined spectrum can then be fitted.}
    \label{fig:simulated transients}
\end{figure}

 
\paragraph{Coil Sensitivity}
A variety of coil combination techniques can be used to successfully combine multi-coil spectra. While these techniques differ in how they calculate the weights, all of them use weights to scale the transients before averaging. Assigning context, such as water peak height or coil sensitivity maps, to these weights when planning the simulations can help define the necessary parameter ranges and distributions to be in line with a given \DIFdelbegin \DIFdel{clinical }\DIFdelend \DIFaddbegin \DIFadd{acquisition }\DIFaddend protocol.

\subsubsection{Final Steps} The desired use case will determine if a FID or a spectrum is necessary. If a FID is required, the simulation is finished and the data will be exported. If a spectrum is required, the Fourier transform will recover the spectrum at which point it can be cropped and resampled to a desired ppm range and spectral length. The default interpolation technique in this framework is a cubic Hermite modified Akima interpolator with momentum.


\subsection{Exporting Data}\label{subsec:exporting data}
The default export file format is .mat. These files include the data, spectral fits, simulation parameters, baseline offsets, and quantification results. To facilitate \DIFdelbegin \DIFdel{using }\DIFdelend \DIFaddbegin \DIFadd{the use of }\DIFaddend the simulated spectra in various software packages, they are also exported in the NIfTI-MRS format\cite{Clarke2022}.

\subsection{Fitting Parameter Analysis}\label{subsec:Fitting Parameter Analysis}
The process of simulating a new dataset requires careful consideration of various factors, including the selection of appropriate parameter ranges and distributions. \DIFdelbegin \DIFdel{The optimal customization }\DIFdelend \DIFaddbegin \DIFadd{Customization }\DIFaddend of these parameters depends on the intended use and application of the dataset. For \DIFdelbegin \DIFdel{instance, }\DIFdelend \DIFaddbegin \DIFadd{example, when creating }\DIFaddend deep learning-based quantification models\DIFdelbegin \DIFdel{benefit from }\DIFdelend \DIFaddbegin \DIFadd{, it is beneficial to use }\DIFaddend independent, uniform distributions that include all values the model will be expected to encounter. \DIFdelbegin \DIFdel{When }\DIFdelend \DIFaddbegin \DIFadd{On the other hand, when }\DIFaddend validating a traditional spectral fitting model that includes soft constraints, it is crucial to incorporate those constraints when defining the parameter distributions. This ensures that the simulated dataset accurately reflects the underlying distribution of the target dataset. 

To \DIFdelbegin \DIFdel{mimic an in vivo dataset, accurate }\DIFdelend \DIFaddbegin \DIFadd{create a dataset that accurately mimics in vivo conditions, it is crucial to have precise }\DIFaddend descriptions of clinical fitting parameters\DIFdelbegin \DIFdel{are crucially important}\DIFdelend \DIFaddbegin \DIFadd{. This work does not provide scenario-specific parameter recommendations, as it is beyond the scope of this work. However, some tools are provided to assist in identifying ranges and distributions to match an existing dataset}\DIFaddend . In collaboration with \DIFdelbegin \DIFdel{Osprey, it is now possible }\DIFdelend \DIFaddbegin \DIFadd{the developers of Osprey\mbox{%DIFAUXCMD
\cite{Oeltzschner2020}}\hspace{0pt}%DIFAUXCMD
, new functionality was added to their software }\DIFaddend to export the spectral fitting parameters after quantification. \DIFdelbegin \DIFdel{Tools }\DIFdelend \DIFaddbegin \DIFadd{The tools }\DIFaddend in this framework can \DIFdelbegin \DIFdel{then load the }\DIFdelend \DIFaddbegin \DIFadd{load those }\DIFaddend exported files and prepare the data for further analysis. Currently, this framework uses the \DIFdelbegin \DIFdel{python }\DIFdelend \DIFaddbegin \DIFadd{Python }\DIFaddend library Fitter\cite{Cokelaer2019} to identify the \DIFdelbegin \DIFdel{best fitting }\DIFdelend \DIFaddbegin \DIFadd{best-fitting }\DIFaddend probability distribution for \DIFdelbegin \DIFdel{every }\DIFdelend \DIFaddbegin \DIFadd{each }\DIFaddend parameter. \textit{A priori} knowledge, either from prior knowledge or data exploration, can narrow down the search range and \DIFdelbegin \DIFdel{speed up }\DIFdelend \DIFaddbegin \DIFadd{accelerate }\DIFaddend the analysis. The \DIFdelbegin \DIFdel{outputs }\DIFdelend \DIFaddbegin \DIFadd{results }\DIFaddend for each parameter include evaluation metrics for the best performing distributions as well as a numerical characterization of the best fitting distribution.


\DIFdelbegin \subsubsection{\DIFdel{Recommendations}}
%DIFAUXCMD
\addtocounter{subsubsection}{-1}%DIFAUXCMD
\DIFdel{The authors generally recommend that simulations include all relevant artifacts unless there is a specific reason to exclude them. A simulated dataset should include all phenomena that are expected to be encountered when the final work is deployed. Even highly accurate post-processing techniques have limitations and biases and leave some residue of the corrected artifacts. To ensure consistency between the simulated and clinical data, the artifacts should be included in the simulations and removed via the users’ own fitting protocols.  
}%DIFDELCMD < 

%DIFDELCMD < %%%
\DIFdel{Although not recommended, residual artifacts and post-processing techniques can be included in the simulations. Phase and frequency corrections can be simulated by applying a minimal offset during the initial simulation, which can be implemented in the parameter sampling protocol. Similarly, eddy currents can be scaled down by minimizing the sampled amplitudes. While not part of the acquisition protocol, apodization and zero filling are also possible. Apodization improves the SNR by multiplying the FID by a filter function, typically an exponential decay function or a Lorenztian-to-Gaussian transform. This framework implements an exponential decay as a function of time, $t$, and $T_L$ which defines the amount of apodization in Hz. Zero filling simply pads the FID with zeros to a defined length before the Fourier transform.
}%DIFDELCMD < 

%DIFDELCMD < %%%
\DIFdelend \subsection{Code}
This repository was written in PyTorch 1.11.0 and Python 3.9.7. Since this framework generates batches of spectra instead of individual spectra sequentially, a simulation batch size needs to be specified which will be affected by the spectral length and complexity of the simulations. As long as the batch size is set appropriately given the users' amount of RAM, this framework can be employed on standard computers without any special hardware. After publication, the repository will be available on GitHub, at \DIFdelbegin %DIFDELCMD < \todo{https://www.github.com/REPOSITORY}%%%
\DIFdelend \DIFaddbegin \DIFadd{https://github.com/JohnLaMaster/MRS-Sim}\DIFaddend , and MRSHub.

\DIFdelbegin \section{\DIFdel{Results}}%DIFAUXCMD
\addtocounter{section}{-1}%DIFAUXCMD
%DIFDELCMD < \label{sec:Results}
%DIFDELCMD < %%%
\DIFdelend \DIFaddbegin \DIFadd{Metabolite and model parameter recommendations are provided as default values and are included in the appendix and the repository.Model parameter values generally come from the default values of spectral fitting programs\mbox{%DIFAUXCMD
\cite{Oeltzschner2020,Provencher1993,Simpson2017} }\hspace{0pt}%DIFAUXCMD
while the parameters describing the metabolites come from literature\mbox{%DIFAUXCMD
\cite{deGraaf2007,deGraaf2018,Gudmundson2023,Landheer2021,Wermter2017,Wyss2018}}\hspace{0pt}%DIFAUXCMD
. For the most current information, please refer to the repository.
}\DIFaddend 


 
\DIFdelbegin \subsection{\DIFdel{Simulations}}
%DIFAUXCMD
\addtocounter{subsection}{-1}%DIFAUXCMD
%DIFDELCMD < \begin{figure}[t!]
%DIFDELCMD <     \centering
%DIFDELCMD <     \begin{tabular}[c]{ccc}
%DIFDELCMD <     \begin{subfigure}[c]{0.31\textwidth}
%DIFDELCMD <         \includegraphics[width=0.93\textwidth,keepaspectratio]{images/30ms_samples/curated/30ms_curated_sample{1}.eps}
%DIFDELCMD <         \vspace{3pt}
%DIFDELCMD <     \end{subfigure}&
%DIFDELCMD <     \begin{subfigure}[c]{0.31\textwidth}
%DIFDELCMD <         \includegraphics[width=0.93\textwidth,keepaspectratio]{images/30ms_samples/curated/30ms_curated_sample{2}.eps}
%DIFDELCMD <         \vspace{3pt}
%DIFDELCMD <     \end{subfigure}&
%DIFDELCMD <     \begin{subfigure}[c]{0.31\textwidth}
%DIFDELCMD <         \includegraphics[width=0.93\textwidth,keepaspectratio]{images/30ms_samples/curated/30ms_curated_sample{3}.eps}
%DIFDELCMD <         \vspace{3pt}
%DIFDELCMD <     \end{subfigure}\\
%DIFDELCMD <     \begin{subfigure}[c]{0.31\textwidth}
%DIFDELCMD <         \includegraphics[width=0.93\textwidth,keepaspectratio]{images/30ms_samples/curated/30ms_curated_sample{4}.eps}
%DIFDELCMD <         \vspace{3pt}
%DIFDELCMD <     \end{subfigure}&
%DIFDELCMD <     \begin{subfigure}[c]{0.31\textwidth}
%DIFDELCMD <         \includegraphics[width=0.93\textwidth,keepaspectratio]{images/30ms_samples/curated/30ms_curated_sample{5}.eps}
%DIFDELCMD <         \vspace{3pt}
%DIFDELCMD <     \end{subfigure}&%%%
%DIF < 
    %DIFDELCMD < \begin{subfigure}[c]{0.31\textwidth}
%DIFDELCMD <         \includegraphics[width=0.93\textwidth,keepaspectratio]{images/30ms_samples/curated/30ms_curated_sample{6}.eps}
%DIFDELCMD <         \vspace{3pt}
%DIFDELCMD <     \end{subfigure}\\
%DIFDELCMD <     \begin{subfigure}[c]{0.31\textwidth}
%DIFDELCMD <         \includegraphics[width=0.93\textwidth,keepaspectratio]{images/30ms_samples/curated/30ms_curated_sample{7}.eps}
%DIFDELCMD <         \vspace{3pt}
%DIFDELCMD <     \end{subfigure}&
%DIFDELCMD <     \begin{subfigure}[c]{0.31\textwidth}
%DIFDELCMD <         \includegraphics[width=0.93\textwidth,keepaspectratio]{images/30ms_samples/curated/30ms_curated_sample{8}.eps}
%DIFDELCMD <         \vspace{3pt}
%DIFDELCMD <     \end{subfigure}&
%DIFDELCMD <     \begin{subfigure}[c]{0.31\textwidth}
%DIFDELCMD <         \includegraphics[width=0.93\textwidth,keepaspectratio]{images/30ms_samples/curated/30ms_curated_sample{9}.eps}
%DIFDELCMD <         \vspace{3pt}
%DIFDELCMD <     \end{subfigure}\\
%DIFDELCMD <     \begin{subfigure}[c]{0.31\textwidth}
%DIFDELCMD <         \includegraphics[width=0.93\textwidth,keepaspectratio]{images/30ms_samples/curated/30ms_curated_sample{10}.eps}
%DIFDELCMD <         \vspace{3pt}
%DIFDELCMD <     \end{subfigure}&
%DIFDELCMD <     \begin{subfigure}[c]{0.31\textwidth}
%DIFDELCMD <         \includegraphics[width=0.93\textwidth,keepaspectratio]{images/30ms_samples/curated/30ms_curated_sample{11}.eps}
%DIFDELCMD <         \vspace{3pt}
%DIFDELCMD <     \end{subfigure}&%%%
%DIF < 
    %DIFDELCMD < \begin{subfigure}[c]{0.31\textwidth}
%DIFDELCMD <         \includegraphics[width=0.93\textwidth,keepaspectratio]{images/30ms_samples/curated/30ms_curated_sample{12}.eps}
%DIFDELCMD <         \vspace{3pt}
%DIFDELCMD <     \end{subfigure}\\
%DIFDELCMD <     \begin{subfigure}[c]{0.31\textwidth}
%DIFDELCMD <         \includegraphics[width=0.93\textwidth,keepaspectratio]{images/30ms_samples/curated/30ms_curated_sample{13}.eps}
%DIFDELCMD <     \end{subfigure}&
%DIFDELCMD <     \begin{subfigure}[c]{0.31\textwidth}
%DIFDELCMD <         \includegraphics[width=0.93\textwidth,keepaspectratio]{images/30ms_samples/curated/30ms_curated_sample{14}.eps}
%DIFDELCMD <     \end{subfigure}&%%%
%DIF < 
    %DIFDELCMD < \begin{subfigure}[c]{0.31\textwidth}
%DIFDELCMD <         \includegraphics[width=0.93\textwidth,keepaspectratio]{images/30ms_samples/curated/30ms_curated_sample{15}.eps}
%DIFDELCMD <     \end{subfigure}
%DIFDELCMD <     \end{tabular}
%DIFDELCMD <     %%%
%DIFDELCMD < \caption{%
{%DIFAUXCMD
\DIFdelFL{Sample spectra simulated for a PRESS sequence with TE=30ms that highlight the effect of the baseline and residual water contributions.}}
    %DIFAUXCMD
%DIFDELCMD < \label{fig:30ms samples curated clean}
%DIFDELCMD < \end{figure}
%DIFDELCMD < %%%
\DIFdelend \DIFaddbegin \subsubsection{\DIFadd{Data Evaluation}}\label{methods:data evaluation}%DIF >  and Analysis
\DIFadd{Validating synthetic data is challenging because there is no gold standard and the realness of the data depends on both the simulation methods, i.e. equations, and the simulation parameter values. This makes evaluating the simulated spectra directly difficult. 
The scope of this work is focused on the simulation framework itself instead of recommending in vivo parameter values. Therefore, the most appropriate approach for evaluating this protocol is to evaluate the simulation methods described above. Even though there is no quantitative metric describing the degree of in vivo realness, it is still important to evaluate the model outputs qualitatively. 
}\DIFaddend 

The selection of simulations presented in \DIFdelbegin \DIFdel{this section }\DIFdelend \DIFaddbegin \DIFadd{Sec. \ref{sec:Results} }\DIFaddend focus on short echo (TE=30ms) 3T PRESS spectra with a spectral width of 2000Hz and randomly sampled parameters. The concentrations were sampled with respect to total creatine (tCr). \DIFdelbegin \DIFdel{It is important to note that while pulse sequence implications are integral to the overall simulation process, their detailed exploration is beyond the scope of this work. Therefore, in this study, we report simulations specifically tailored to the PRESS sequence.
}%DIFDELCMD < 

%DIFDELCMD < %%%
\DIFdelend The choice of short echo spectra is motivated by their ability to capture a broader range of metabolite peaks compared to long echo spectra. The simulations presented include metabolites sampled from a comprehensive set of common brain metabolites including Asc, Asp, Ch, Cr, GABA, Gln, Glu, GPC, GSH, Lac, mI, NAA, NAAG, PCh, PCr, PE, sI, Tau, and a variety of macromolecular and lipid basis functions. For consistency, the SNR was fixed to 15dB and the chemical shift reference point \DIFdelbegin \DIFdel{is }\DIFdelend \DIFaddbegin \DIFadd{was }\DIFaddend set to 4.65ppm. \DIFaddbegin \DIFadd{The metabolite concentrations and lineshapes were fixed to further emphasize the effects of the simulated artifacts. 
}

\DIFadd{Two individual spectra were simulated as templates to showcase the framework's capabilities. The samples in Fig. \ref{fig:30ms samples curated clean} show a single spectrum with various sampled baseline offests and residual water signals. The samples in Fig. 
\ref{fig:30ms samples curated dirty} were generated by sampling and randomly applying all spectral artifacts, except zero-order phase because of how much it obfuscates spectral details.
}

\DIFadd{It is important to note that while pulse sequence implications are integral to the overall simulation process, their detailed exploration is beyond the scope of this work. Therefore, in this study, the simulations are specifically tailored to the PRESS sequence. The main objective of this work is to manipulate pre-simulated basis sets until they approximate in vivo spectra. Therefore, the primary machinations of MRS-Sim are the same regardless of the basis functions used. Overall, the presented simulations using the PRESS sequence provide a valuable foundation for understanding the performance and capabilities of the MRS-Sim framework.
}



\section{\DIFadd{Results \& Discussion}}\label{sec:Results}
%DIF >  The selection of simulations presented in this section focus on short echo (TE=30ms) 3T PRESS spectra with a spectral width of 2000Hz and randomly sampled parameters. The concentrations were sampled with respect to total creatine (tCr). The choice of short echo spectra is motivated by their ability to capture a broader range of metabolite peaks compared to long echo spectra. The simulations presented include metabolites sampled from a comprehensive set of common brain metabolites including Asc, Asp, Ch, Cr, GABA, Gln, Glu, GPC, GSH, Lac, mI, NAA, NAAG, PCh, PCr, PE, sI, Tau, and a variety of macromolecular and lipid basis functions. For consistency, the SNR was fixed to 15dB and the chemical shift reference point was set to 4.65ppm.

%DIF >  It is important to note that while pulse sequence implications are integral to the overall simulation process, their detailed exploration is beyond the scope of this work. Therefore, in this study, the simulations are specifically tailored to the PRESS sequence. 
%DIF >  % While the pulse sequence implications are acknowledged as an important aspect of MRS simulations, their exploration is beyond the immediate scope of this work. 
%DIF >  The main objective of this work is to manipulate pre-simulated basis sets until they approximate in vivo spectra. Therefore, the primary machinations of MRS-Sim are the same regardless of the basis functions used. Overall, the presented simulations using the PRESS sequence provide a valuable foundation for understanding the performance and capabilities of the MRS-Sim framework.


\subsection{\DIFadd{Baseline and Residual Water Generator}}\label{resutls:baseline}
\begin{figure}[!Ht]
    \centering
    \begin{tabular}[c]{ccc}
    \begin{subfigure}[c]{0.31\textwidth}
        \includegraphics[width=0.93\textwidth,keepaspectratio]{images/30ms_samples/curated/30ms_curated_sample{1}.eps}
        \vspace{3pt}
    \end{subfigure}&
    \begin{subfigure}[c]{0.31\textwidth}
        \includegraphics[width=0.93\textwidth,keepaspectratio]{images/30ms_samples/curated/30ms_curated_sample{2}.eps}
        \vspace{3pt}
    \end{subfigure}&
    \begin{subfigure}[c]{0.31\textwidth}
        \includegraphics[width=0.93\textwidth,keepaspectratio]{images/30ms_samples/curated/30ms_curated_sample{3}.eps}
        \vspace{3pt}
    \end{subfigure}\\
    \begin{subfigure}[c]{0.31\textwidth}
        \includegraphics[width=0.93\textwidth,keepaspectratio]{images/30ms_samples/curated/30ms_curated_sample{4}.eps}
        \vspace{3pt}
    \end{subfigure}&
    \begin{subfigure}[c]{0.31\textwidth}
        \includegraphics[width=0.93\textwidth,keepaspectratio]{images/30ms_samples/curated/30ms_curated_sample{5}.eps}
        \vspace{3pt}
    \end{subfigure}&%DIF > 
    \begin{subfigure}[c]{0.31\textwidth}
        \includegraphics[width=0.93\textwidth,keepaspectratio]{images/30ms_samples/curated/30ms_curated_sample{6}.eps}
        \vspace{3pt}
    \end{subfigure}\\
    \begin{subfigure}[c]{0.31\textwidth}
        \includegraphics[width=0.93\textwidth,keepaspectratio]{images/30ms_samples/curated/30ms_curated_sample{7}.eps}
        \vspace{3pt}
    \end{subfigure}&
    \begin{subfigure}[c]{0.31\textwidth}
        \includegraphics[width=0.93\textwidth,keepaspectratio]{images/30ms_samples/curated/30ms_curated_sample{8}.eps}
        \vspace{3pt}
    \end{subfigure}&
    \begin{subfigure}[c]{0.31\textwidth}
        \includegraphics[width=0.93\textwidth,keepaspectratio]{images/30ms_samples/curated/30ms_curated_sample{9}.eps}
        \vspace{3pt}
    \end{subfigure}\\
    \begin{subfigure}[c]{0.31\textwidth}
        \includegraphics[width=0.93\textwidth,keepaspectratio]{images/30ms_samples/curated/30ms_curated_sample{10}.eps}
        \vspace{3pt}
    \end{subfigure}&
    \begin{subfigure}[c]{0.31\textwidth}
        \includegraphics[width=0.93\textwidth,keepaspectratio]{images/30ms_samples/curated/30ms_curated_sample{11}.eps}
        \vspace{3pt}
    \end{subfigure}&%DIF > 
    \begin{subfigure}[c]{0.31\textwidth}
        \includegraphics[width=0.93\textwidth,keepaspectratio]{images/30ms_samples/curated/30ms_curated_sample{12}.eps}
        \vspace{3pt}
    \end{subfigure}\\
    \begin{subfigure}[c]{0.31\textwidth}
        \includegraphics[width=0.93\textwidth,keepaspectratio]{images/30ms_samples/curated/30ms_curated_sample{13}.eps}
    \end{subfigure}&
    \begin{subfigure}[c]{0.31\textwidth}
        \includegraphics[width=0.93\textwidth,keepaspectratio]{images/30ms_samples/curated/30ms_curated_sample{14}.eps}
    \end{subfigure}&%DIF > 
    \begin{subfigure}[c]{0.31\textwidth}
        \includegraphics[width=0.93\textwidth,keepaspectratio]{images/30ms_samples/curated/30ms_curated_sample{15}.eps}
    \end{subfigure}
    \end{tabular}
    \caption{\DIFaddFL{Sample spectra simulated for a PRESS sequence with TE=30ms that highlight the effect of the baseline and residual water contributions.}}
    \label{fig:30ms samples curated clean}
\end{figure}
\DIFaddend 

Fig. \ref{fig:30ms samples curated clean} illustrates \DIFaddbegin \DIFadd{a single }\DIFaddend clean short echo (TE=30ms) PRESS \DIFdelbegin \DIFdel{spectra }\DIFdelend \DIFaddbegin \DIFadd{spectrum }\DIFaddend showcasing various combinations of residual water and baseline contributions. \DIFaddbegin \DIFadd{The metabolite concentrations and lineshapes were fixed in addition to the settings described above. }\DIFaddend These samples omit spectral artifacts to more clearly highlight the variety that can be achieved by randomly sampling \DIFdelbegin \DIFdel{the simulation }\DIFdelend parameters for the \DIFdelbegin \DIFdel{physics model and the }\DIFdelend baseline and residual water generator. 
\DIFdelbegin \DIFdel{In contrast, Fig. \ref{fig:30ms samples curated dirty} presents a series of simulated PRESS spectra(TE=30ms) with randomly sampled parameters, artifacts, and offsets. The baselines and residual water regions shown sometimes appear to be uncorrelated with the depicted spectra due to additional artifacts that are applied after all of the spectral components are combined. Sophisticated simulations, such as these, are useful for developing and validating artifact removal techniques and spectral fitting protocols .  
}%DIFDELCMD < \begin{figure}[ht!]
%DIFDELCMD <     %%%
\DIFdelendFL \DIFaddbeginFL 

\DIFaddFL{Currently, it is unknown what a true baseline actually looks like. Theory and protocols regarding baseline modeling have been developed extensively, but the physical phenomena underlying the baseline signal is still poorly understood. Different modeling protocols can produce different baselines. Bazgir et al.\mbox{%DIFAUXCMD
\cite{Bazgir2018} }\hspace{0pt}%DIFAUXCMD
interpolate between selected minima in the spectra, Wilson et al.\mbox{%DIFAUXCMD
\cite{Wilson2021} }\hspace{0pt}%DIFAUXCMD
uses penalized B-splines to overparametize the problem space which is solved using an optimized smoothing constraint, while Osprey\mbox{%DIFAUXCMD
\cite{Oeltzschner2020} }\hspace{0pt}%DIFAUXCMD
uses unregularized B-splines spread every 0.4 ppm to enforce smoothness. Even though all of these techniques have been proved useful, in vivo data does not have known ground truths meaning there is no way to identify which method is the most accurate. Without a physics-based model, other methods of baseline simulation are necessary. 
}

\DIFaddFL{Fig. \ref{fig:30ms samples curated clean} shows a variety of baseline profiles that can be simulated with the presented framework. Instead of claiming to produce in vivo baselines, the proposed generator produces a wide variety of offsets that approximate the baselines extracted by traditional methods. The motivation behind this approach is that if the generator cannot be limited to strictly in vivo-like baselines, then it should incorporate a variety of appropriate baseline profiles such that true baselines are included. Because this generator is not based on a baseline fitting method, future work could use it to evaluate the baseline modeling performance of various fitting protocols given different baseline profiles.
}

%DIF >  When evaluating Fig. \ref{fig:30ms samples curated clean}, it should be noted that it is currently unknown what a true baseline looks like. 
%DIF >  Different baseline modeling protocols produce different baselines and because in vivo data does not have known ground truths, there is no way to identify which method is the most correct. 
%DIF >  Because of this, the proposed generator produces a wide variety of baselines that approximate the baselines extracted by traditional methods. The motivation behind this approach is the idea that if the generator cannot be limited to strictly in vivo-like baselines, then it should incorporate a variety of appropriate baseline profiles such that true baselines are included. Because this generator is not based on a baseline fitting method, future work could use it to evaluate the baseline modeling performance of various fitting protocols given different baseline profiles.


\subsection{\DIFaddFL{Complete Model}}\label{results:complete model}
\begin{figure}[Ht!]
    \DIFaddendFL \centering
    \begin{tabular}[c]{ccc}
    \begin{subfigure}[c]{0.31\textwidth}
        \includegraphics[width=0.93\textwidth]{images/30ms_samples/dirty/30ms_curated_dirty_sample{1}.eps}
        \vspace{3pt}
    \end{subfigure}&
    \begin{subfigure}[c]{0.31\textwidth}
        \includegraphics[width=0.93\textwidth]{images/30ms_samples/dirty/30ms_curated_dirty_sample{2}.eps}
        \vspace{3pt}
    \end{subfigure}&
    \begin{subfigure}[c]{0.31\textwidth}
        \includegraphics[width=0.93\textwidth]{images/30ms_samples/dirty/30ms_curated_dirty_sample{3}.eps}
        \vspace{3pt}
    \end{subfigure}\\
    \begin{subfigure}[c]{0.31\textwidth}
        \includegraphics[width=0.93\textwidth]{images/30ms_samples/dirty/30ms_curated_dirty_sample{4}.eps}
        \vspace{3pt}
    \end{subfigure}&
    \begin{subfigure}[c]{0.31\textwidth}
        \includegraphics[width=0.93\textwidth]{images/30ms_samples/dirty/30ms_curated_dirty_sample{5}.eps}
        \vspace{3pt}
    \end{subfigure}&%
    \begin{subfigure}[c]{0.31\textwidth}
        \includegraphics[width=0.93\textwidth]{images/30ms_samples/dirty/30ms_curated_dirty_sample{6}.eps}
        \vspace{3pt}
    \end{subfigure}\\
    \begin{subfigure}[c]{0.31\textwidth}
        \includegraphics[width=0.93\textwidth]{images/30ms_samples/dirty/30ms_curated_dirty_sample{7}.eps}
        \vspace{3pt}
    \end{subfigure}&
    \begin{subfigure}[c]{0.31\textwidth}
        \includegraphics[width=0.93\textwidth]{images/30ms_samples/dirty/30ms_curated_dirty_sample{8}.eps}
        \vspace{3pt}
    \end{subfigure}&
    \begin{subfigure}[c]{0.31\textwidth}
        \includegraphics[width=0.93\textwidth]{images/30ms_samples/dirty/30ms_curated_dirty_sample{9}.eps}
        \vspace{3pt}
    \end{subfigure}\\
    \begin{subfigure}[c]{0.31\textwidth}
        \includegraphics[width=0.93\textwidth]{images/30ms_samples/dirty/30ms_curated_dirty_sample{10}.eps}
        \vspace{3pt}
    \end{subfigure}&
    \begin{subfigure}[c]{0.31\textwidth}
        \includegraphics[width=0.93\textwidth]{images/30ms_samples/dirty/30ms_curated_dirty_sample{11}.eps}
        \vspace{3pt}
    \end{subfigure}&%
    \begin{subfigure}[c]{0.31\textwidth}
        \includegraphics[width=0.93\textwidth]{images/30ms_samples/dirty/30ms_curated_dirty_sample{12}.eps}
        \vspace{3pt}
    \end{subfigure}\\
    \begin{subfigure}[c]{0.31\textwidth}
        \includegraphics[width=0.93\textwidth]{images/30ms_samples/dirty/30ms_curated_dirty_sample{13}.eps}
    \end{subfigure}&
    \begin{subfigure}[c]{0.31\textwidth}
        \includegraphics[width=0.93\textwidth]{images/30ms_samples/dirty/30ms_curated_dirty_sample{14}.eps}
    \end{subfigure}&%
    \begin{subfigure}[c]{0.31\textwidth}
        \includegraphics[width=0.93\textwidth]{images/30ms_samples/dirty/30ms_curated_dirty_sample{15}.eps}
    \end{subfigure}\\
    \end{tabular}
    \caption{Sample spectra, similar to Fig. \ref{fig:30ms samples curated clean} [PRESS, TE=30ms], with randomly sampled, uncorrected artifacts to approximate raw data.}%Sample spectra simulated for a PRESS sequence with TE=30ms. These spectra have sampled parameters just like Fig. \ref{fig:30ms samples curated clean} plus a variety of uncorrected artifacts including eddy currents, zero- and first-order phase offsets, frequency shifts, macromolecule and lipid contributions, residual water, and baseline offsets.}
    \label{fig:30ms samples curated dirty}
\end{figure}


\DIFdelbegin \DIFdel{While the pulse sequence implications are acknowledged as an important aspect of MRS simulations, their exploration is beyond the immediate scope of this work. The main objective of this work is take manipulate pre-simulated basis sets until they approximate in vivo spectra. Therefore, the primary machinations of MRS-Sim are the same regardless of the basis functions used. Overall, the presented simulations using the PRESS sequence provide a valuable foundation for understanding the performance and capabilities of the MRS-Sim }\DIFdelend \DIFaddbegin \DIFadd{In contrast, Fig. \ref{fig:30ms samples curated dirty} presents a simulated PRESS spectrum (TE=30ms) with randomly sampled artifacts and offsets. %DIF > The dropout probability for each parameter was set to 50\%. This means that the model parameters, including metabolites, are randomly omitted from the simulations. This helps to emphasize the variety of outputs that are possible for a single set of defined ranges and distributions. 
This figure highlights the variety a single spectrum can assume just by randomly sampling the artifacts. Sophisticated simulations, such as these, are useful for developing and validating data processing techniques such as artifact removal and new spectral fitting protocols. Spectra can be simulated to be as clean or as artifact-laden as desired, all while maintaining known ground truth values. %DIF > Because every component in these simulations has a known ground truth, even the most challenging spectra can 
}

%DIF >  It is important to highlight that while 
\DIFadd{Upon closer inspection of Fig. \ref{fig:30ms samples curated dirty}, the baselines and residual water regions sometimes appear to be uncorrelated with the depicted spectra, but they are in fact paired. These discrepancies are due to the additional artifacts that are applied to the simulations after all of the spectral components are combined. The plotted baseline and residual water regions are the ground truth signals and do not have other artifacts applied to them. 
}

\DIFadd{Incorporating a robust collection of artifacts and phenomena commonly encountered with in vivo data into these simulations, makes resulting datasets more closely approximate raw, in vivo data. Even though post-processing techniques are highly accurate, they have limitations and biases, leaving some residue of the corrected artifacts. Including these artifacts in the simulations and removing them with the users' own post-processing and fitting protocols ensures consistency between simulated and in vivo data. These artifacts can also be scaled down in the simulations to emulate residual artifacts. However, this is not ideal because it cannot be guaranteed that scaling down the artifacts will accurately reflect the biases and residues found in the in vivo data.
}

%DIF >  Deep learning and machine learning techniques additionally benefit from robust synthetic data. Fine-grained detail, such as sampling moiety-level T2 values for example, may not be essential for every use case. However, in a deep learning setting, such detail acts as a form of data augmentation. Data augmentation techniques maintain the underlying data but manipulate its appearance so that models learn a broader range of features instead of overfitting a simplified pattern. Such techniques are standard practice in deep learning.

\DIFadd{Deep learning techniques also benefit from robust and consistent synthetic data. Ensuring consistency of the synthetic training data with the in vivo data promotes better model performance. While including fine-grained detail, such as sampling moiety-level T2 values, may not be essential for every use case, in a deep learning setting, it acts as a form of data augmentation. Data augmentation techniques maintain the underlying data but manipulate its appearance so that models learn a broader range of features instead of overfitting a single pattern. Such techniques are standard practice in deep learning and are an inherent feature of this }\DIFaddend framework. 

%DIF >  This has several specific benefits.
\DIFaddbegin 

%DIF >  --->>> deep learning remove with own protocol
%DIF >  benefits


%DIF >  The authors recommend that simulations include all relevant artifacts unless there is a specific reason to exclude them. 
%DIF >  A simulated dataset should include all phenomena that are expected to be encountered when the final work is deployed. 
%DIF >  Even though post-processing techniques are highly accurate, they have limitations and biases, leaving some residue of the corrected artifacts. 
%DIF >  To ensure consistency between the simulated and clinical data, the artifacts should be included in the simulations and removed via the users’ own preprocessing and fitting protocols. 
%DIF >  Although not recommended, residual artifacts and some post-processing techniques can be included in the simulations. 
%DIF >  Phase and frequency corrections can be simulated by applying a minimal offset during the initial simulation, which can be implemented in the parameter sampling protocol. Similarly, eddy currents can be scaled down by minimizing the sampled amplitudes. While not part of the acquisition protocol, apodization and zero filling are also possible. Apodization improves the SNR by multiplying the FID by a filter function, typically an exponential decay function or a Lorenztian-to-Gaussian transform. This framework implements an exponential decay as a function of time, t, and TL which defines the amount of apodization in Hz. Zero filling simply pads the FID with zeros to a defined length before the Fourier transform. 




%DIF >  Here it should be clarified that the baselines and residual water regions shown sometimes appear to be uncorrelated with the depicted spectra. This is due to additional artifacts that are applied to the simulations after all of the spectral components are combined. The plotted baseline and residual water regions are the ground truths and do not have additional artifacts applied to them. %Sophisticated simulations, such as these, are useful for developing and validating artifact removal techniques and spectral fitting protocols.  


 
%DIF >  \subsubsection{Recommendations}
%DIF >  The authors generally recommend that simulations include all relevant artifacts unless there is a specific reason to exclude them. A simulated dataset should include all phenomena that are expected to be encountered when the final work is deployed. Even highly accurate post-processing techniques have limitations and biases and leave some residue of the corrected artifacts. To ensure consistency between the simulated and clinical data, the artifacts should be included in the simulations and removed via the users’ own preprocessing and fitting protocols.  

%DIF >  Although not recommended, residual artifacts and some post-processing techniques can be included in the simulations. Phase and frequency corrections can be simulated by applying a minimal offset during the initial simulation, which can be implemented in the parameter sampling protocol. Similarly, eddy currents can be scaled down by minimizing the sampled amplitudes. While not part of the acquisition protocol, apodization and zero filling are also possible. Apodization improves the SNR by multiplying the FID by a filter function, typically an exponential decay function or a Lorenztian-to-Gaussian transform. This framework implements an exponential decay as a function of time, $t$, and $T_L$ which defines the amount of apodization in Hz. Zero filling simply pads the FID with zeros to a defined length before the Fourier transform.

%DIF >  Metabolite and model parameter recommendations are provided as default values and are included in the appendix. Model parameter values generally come from the default values of spectral fitting programs\cite{Oeltzschner2020,Provencher1993,Simpson2017} while the parameters describing the metabolites come from literature\cite{deGraaf2007,deGraaf2018,Gudmundson2023,Landheer2021,Wermter2017,Wyss2018}. For the most current information, please refer to the repository.
\DIFaddend \section{\DIFdelbegin \DIFdel{Discussions}\DIFdelend \DIFaddbegin \DIFadd{Conclusions}\DIFaddend }\label{sec:Conclusions}
\DIFdelbegin \DIFdel{The }\DIFdelend \DIFaddbegin \DIFadd{In recent years, the }\DIFaddend use of synthetic MRS data has \DIFdelbegin \DIFdel{gained significant interest in recent years }\DIFdelend \DIFaddbegin \DIFadd{become increasingly popular }\DIFaddend due to the need for large datasets with known spectral components\DIFaddbegin \DIFadd{. This is useful }\DIFaddend for both traditional spectroscopy and deep learning applications. \DIFdelbegin \DIFdel{Synthetic }\DIFdelend \DIFaddbegin \DIFadd{Using synthetic }\DIFaddend data allows researchers to \DIFdelbegin \DIFdel{generate }\DIFdelend \DIFaddbegin \DIFadd{create }\DIFaddend unlimited spectra with known ground truth values\DIFdelbegin \DIFdel{which has wide-ranging }\DIFdelend \DIFaddbegin \DIFadd{. This has many }\DIFaddend applications, including evaluating the accuracy and precision of data analysis methods. However, \DIFdelbegin \DIFdel{the }\DIFdelend \DIFaddbegin \DIFadd{there is a }\DIFaddend lack of standardization in synthetic data generation\DIFaddbegin \DIFadd{, which }\DIFaddend poses challenges in terms of reproducibility and generalizability.

\DIFaddbegin \DIFadd{As discussed in the introduction, researchers currently use a variety of simulation frameworks to generate synthetic data for their particular needs. These frameworks often involve simplifying assumptions for the spectral components to exclude some spectral components that are deemed non-essential for their particular task. These assumptions make synthetic data less generalizable, similar to phantom data which struggles to approximate in vivo data. In general, simulating data has two primary challenges: which spectral components and artifacts to include and what parameter values to use for the included components. These choices can be difficult for expert users, let alone non-expert users. Moreover, the heterogeneity in the simulation methods used makes reproducibility challenging.%DIF > Even expert users can struggle to find appropriate values. 
%DIF >  And much like simulating a basis set for a custom pulse sequence requires knowledge that is generally unavailable to non-expert users, in vivo-like simulations can also be 
}

 
\DIFaddend This work has presented an open-source framework for a modular synthetic data generation model that \DIFdelbegin \DIFdel{incorporates well-defined distributions, when available, of physical parameters commonly used in linear-combination modelingsoftware. This framework was intentionally designed so that as research progresses, new information can be added to further }\DIFdelend \DIFaddbegin \DIFadd{includes a comprehensive list of spectral components and acquisition-induced artifacts.
%DIF >  A comprehensive list of spectral components and acquisition-induced artifacts were incorporated. 
Several novel contributions were made to include experimental artifacts that are usually ignored during spectral modeling. These modules are designed to make these simulations comprehensive and in vivo-like. The first contribution is a $B_0$ magnetic field simulator. It is capable of introducing distortions due to imperfect shimming and high susceptibility effects into the simulations. Additionally, a novel generator was proposed that can simulate both broad, undulating baseline offsets and highly irregular residual water contributions. The presented framework is flexible and can be updated with new information as research progresses to }\DIFaddend improve the realness and accuracy of the simulations. 
\DIFdelbegin \DIFdel{It }\DIFdelend %DIF >  was intentionally designed so that as research progresses, new information can be added to further improve the realness and accuracy of the simulations. To further that point, a table of has been compiled
\DIFaddbegin \DIFadd{The appendix and repository include a table that provides up-to-date information about moiety- and metabolite-level characterizations of things like spin-systems, temperature-induced artifacts, T2 values, and metabolite concentration ranges. This information can be continually updated to provide the community with comprehensive and state-of-the-art information about brain metabolites at a glance. Additionally, these suggested values provide a good starting point for simulating datasets. Cumulatively, this framework }\DIFaddend offers a pathway to generate realistic, in vivo-like synthetic data that captures acquisition-induced artifacts and nuisance signals \DIFdelbegin \DIFdel{, }\DIFdelend and can be applied across a range of MRS applications. 
\DIFdelbegin \DIFdel{This is facilitated by the modular implementation that allows the generation highly tailored datasets for a variety of clinical scenarios. This framework includes a $B_0$ magnetic field simulator that is capable of introducing distortions due to imperfect shimming and high susceptibility effects into the simulations. A novel generator was proposed that is capable of simulating both broad, undulating baseline offsets and highly irregular residual water contributions. Finally, a comprehensive list of spectral components and acquisition-induced artifacts were incorporated. Collectively, these provide a comprehensive, robust, and customizable framework for researchers in need of synthetic data}\DIFdelend \DIFaddbegin 

\DIFadd{The modularity of MRS-Sim framework is one of its key feature, allowing for flexible and customizable use of the framework. Firstly, the functions that add artifacts and spectral components are modular, which makes it very easy to understand the code and its purpose. Secondly, it allows for the easy generation of highly customized datasets for various clinical scenarios, as the simulation step itself is also modular. This feature also enables easy community contributions to develop new functionalities, thus preventing the need for entirely new frameworks. New scenarios, such as J-difference edited spectra, diffusion spectra, or, eventually, 2D spectra, can be developed and seamlessly integrated}\DIFaddend .

The development of open-source frameworks for data generation \DIFdelbegin \DIFdel{are crucial for ensuring widespread adoption and improving }\DIFdelend \DIFaddbegin \DIFadd{is crucial to ensure that MRS data is widely adopted, and to improve }\DIFaddend the generalizability of synthetic MRS data and the reproducibility of MRS research. By \DIFdelbegin \DIFdel{open-sourcing this work }\DIFdelend \DIFaddbegin \DIFadd{making this work available to a larger community of researchers}\DIFaddend , the authors \DIFdelbegin \DIFdel{aim to contribute to the democratization of }\DIFdelend \DIFaddbegin \DIFadd{hope to further 
%DIF >  open-sourcing this work, the authors aim to contribute to the democratization 
democratize }\DIFaddend MRS research by providing \DIFdelbegin \DIFdel{access to high quality simulationsto a wider community of researchers interested in the field. Furthermore, this will promote greater standardization and reproducibility in the field. 
}\DIFdelend \DIFaddbegin \DIFadd{easy access to high-quality information and simulations. Improvements in the quality of synthetic data will ultimately lead to better generalizability to in vivo data, directly improving the overall applicability of synthetic data in MRS. 
%DIF >  For example, future research can use this framework to compare the impact of different spectral modeling components on metabolite quantification or to compare the performance of commonly used spectral fitting models. The results of such work would be much less meaningful if simplified simulation methods were used. 
%DIF >  %and greater standardization and reproducibility of synthetic data in MRS. % with the natural consequence being improved overall applicability of synthetic data in MRS. Furthermore, this will promote greater standardization and reproducibility. 
}\DIFaddend Moving forward, collaboration and consensus-building among researchers will be essential to establish standards and best practices for simulating MRS data. Future development can focus on adding additional clinical scenarios to the framework's repertoire, increasing its applicability to \DIFdelbegin \DIFdel{even more aspects of MRS. Further research can use this framework to, for example, compare the impact of different spectral modeling components on metabolite quantification or to compare the performance of commonly used spectral fitting models. }\DIFdelend \DIFaddbegin \DIFadd{more fields within MRS. }\DIFaddend By addressing the challenges associated with synthetic MRS data generation and promoting standardization, MRS can continue to advance in every aspect of the field. 


\newacronym{ML}{ML}{machine learning}
\newacronym{DL}{DL}{deep learning}
\newacronym{Asc}{Asc}{ascorbate}
\newacronym{Asp}{Asp}{aspartate}
\newacronym{Ch}{Ch}{choline}
\newacronym{Cr}{Cr}{creatine}
\newacronym{GABA}{GABA}{gamma-aminobutyric acide}
\newacronym{Gln}{Gln}{glutamine}
\newacronym{Glu}{Glu}{glutamate}
\newacronym{GPC}{GPC}{glycerophosphorylcholine}
\newacronym{GSH}{GSH}{glutathione}
\newacronym{Lac}{Lac}{lactate}
\newacronym{mI}{mI}{myo-inositol}
\newacronym{NAA}{NAA}{N-acetylaspartate}
\newacronym{NAAG}{NAAG}{N-acetylaspartylglutamate}
\newacronym{PCh}{PCh}{phosphocholine}
\newacronym{PCr}{PCr}{phosphocreatine}
\newacronym{PE}{PE}{phosphatidylethanolamine}
\newacronym{sI}{sI}{scyllo-inositol}
\newacronym{Tau}{Tau}{taurine}
\newacronym{tCr}{tCr}{total Creatine}
% \newacronym{FID}{FID}{free induction decay}
% \newacronym{ppm}{ppm}{parts per million}
% \newacronym{SNR}{SNR}{signal-to-noise ratio}
% \newacronym{RAM}{RAM}{random access memory}
% \newacronym{std}{std}{standard deviation}
% \newacronym{MRS}{MRS}{magnetic resonance spectroscopy}
%DIF <  \newacronym{PRESS}{PRESS}{point resolved spectroscopy}
\DIFaddbegin \newacronym{PRESS}{PRESS}{point resolved spectroscopy}
\DIFaddend % \newacronym{MRI}{MRI}{magnetic resonance imaging}
%DIF <  \newacronym{STEAM}{STEAM}{stimulated echo acquisition method}
\DIFaddbegin \newacronym{STEAM}{STEAM}{stimulated echo acquisition method}
\DIFaddend % \newacronym{TE}{TE}{echo time}
% \newacronym{Hz}{Hz}{hertz}
% \newacronym{dB}{dB}{decibel}
\DIFaddbegin \newacronym{MARSS}{MARSS}{Magnetic Resonance Spectrum Simulator}
\newacronym{LASER}{LASER}{localized adiabatic selective refocusing}
\newacronym{sLASER}{sLASER}{semi-localized adiabatic selective refocusing}
\DIFaddend \glsaddall
\section*{Abbreviations}
\begin{multicols}{3}
\printglossary[type=\acronymtype, nonumberlist]
\end{multicols}

\section*{Acknowledgments}
I would like to give sincere thanks to Dr. Tobias Lasser for his kind support and mentorship. I would also like to thank Dr. Dhritiman Das for our insightful conversations and the help he provided with understanding the simulation methods from his own work. Finally, I would like to thank Leah Harper and Ted Loewenberg, from Harper House, who provided great support during the development of this work while I was visiting Dr. Yan Li's lab in San Francisco. 

\subsection*{Financial disclosure}
This work was partially funded by a doctoral stipend from the German Academic Exchange Service (DAAD).

\subsection*{Conflict of interest}
The authors declare no potential conflict of interests.

% \input{sections/supplement.tex}


%\nocite{*}% Show all bib entries - both cited and uncited; comment this line to view only cited bib entries;
\bibliography{mybibliography}
\DIFaddbegin 

%DIF >  \clearpage
%DIF >  \input{tables/sup:metab_characterization}
%DIF >  \input{tables/sup:tab01}
%DIF >  \input{tables/tab:supp:condensed}

%DIF >  % \backmatter
%DIF >  \appendix
%DIF >  \input{supplement}
\DIFaddend 

\end{document}